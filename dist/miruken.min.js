module.exports=require("./ng.js");var miruken=require("../miruken");require("../mvc"),new function(){function $bootstrap(a){_configureRootContext();var b=angular.module;b("ng").run(["$rootScope","$injector",_instrumentScopes]),angular.module=function(a,c,d){var e=b.call(this,a,c,d);if(c){var f=[],g=[],h=Container($rootContext),i=_synthesizeModulePackage(a);e.constant("$rootContext",$rootContext).config(["$injector","$controllerProvider",function(a,b){_installPackage(i,e,a,b,f,g)}]).run(["$injector","$q","$log",function(a,b,c){_provideInjector(rootContainer,a),Array2.forEach(f,function(b){a.invoke(b)}),h.register(g),b.when(h.resolveAll(Starting)).then(function(a){Array2.invoke(a,"start")},function(a){c.error(lang.format("Startup for package %1 failed: %2",i,a.message))})}])}return e}}function _configureRootContext(){$rootContext.addHandlers(rootContainer,new miruken.validate.ValidationCallbackHandler,new miruken.validate.ValidateJsCallbackHandler,new miruken.error.ErrorCallbackHandler)}function _instrumentScopes(a,b){var c=a.constructor.prototype,d=c.$new,e=c.$destroy;c.$new=function(a,b){var c=d.call(this,a,b),e=c.$parent;return c.context=e&&e.context?e.context.newChild():new Context,c},c.$destroy=function(){var a=this.context;a!==$rootContext&&(delete this.context,a.end()),e.call(this)},a.rootContext=a.context=$rootContext,_provideInjector(rootContainer,b)}function _synthesizeModulePackage(a){for(var b=base2,c=a.split("."),d=0;d<c.length;++d){var e=c[d],f=b[e];f||(f=b.addPackage(e),f.lifecycle=PackageLifecycle.Created,b===base2&&(global[e]=f)),b=f}return f}function _installPackage(a,b,c,d,e,f){var g=Container($rootContext),h=a.lifecycle||PackageLifecycle.Created;h===PackageLifecycle.Created&&(a.getClasses(function(a){var f=a.member;if(f.prototype instanceof Controller){var h=new ComponentModel;h.setKey(f),h.setLifestyle(new ContextualLifestyle),g.addComponent(h);var i=_angularDependencies(h);i.unshift("$scope","$injector"),i.push(_componentShim(f,i.slice())),d.register(a.name,i)}else if(f.prototype instanceof Installer||f.prototype instanceof Runner){var i=(f.prototype.$inject||f.$inject||[]).slice(),j=i.indexOf("$module");j>=0&&i.splice(j,1),i.push(function(){var a=arguments;j>=0&&(a=Array.prototype.slice.call(arguments,0),a.splice(j,0,b));var c=f["new"].apply(f,a);c instanceof Installer?g.register(c):c.run()}),f.prototype instanceof Installer?c.invoke(i):e.push(i)}}),f.push($classes.fromPackage(a).basedOn(Starting).withKeys.self()),a.lifecycle=PackageLifecycle.Installed),a.getPackages(function(a){_installPackage(a.member,b,c,d,e,f)})}function _componentShim(a,b){return function(c,d){var e=c.context,f=Array2.combine(b,arguments);return _provideLiteral(e,f),_provideInjector(e,d),e.resolve($instant(a))}}function _provideLiteral(a,b){$provide(a,null,function(a){var c=Modifier.unwrap(a.getKey());return b[c]})}function _provideInjector(a,b){$provide(a,null,function(a){var c=Modifier.unwrap(a.getKey());return $isString(c)&&b.has(c)?b.get(c):void 0})}function _angularDependencies(a){var b=a.getDependencies();return b?Array2.filter(Array2.map(b,function(a){return a.getDependency()}),function(a){return $isString(a)}):[]}if("undefined"==typeof angular)throw new Error("angular not found.  Did you forget to include angular.js first?");var ng=new base2.Package(this,{name:"ng",version:miruken.version,parent:miruken,imports:"miruken,miruken.callback,miruken.context,miruken.ioc,miruken.mvc",exports:"$bootstrap,$rootContext,Runner"});eval(this.imports);var $rootContext=new Context,rootContainer=new IoContainer,PackageLifecycle=Enum({Created:1,Installed:2}),Runner=Base.extend({run:function(){}});eval(this.exports)},base2={name:"base2",version:"1.1 (alpha1)",exports:"Base,Package,Abstract,Module,Enumerable,Map,Collection,RegGrp,Undefined,Null,This,True,False,assignID,global",namespace:""},new function(_no_shrink_){function assignID(a,b){return b||(b=1==a.nodeType?"uniqueID":"base2ID"),a[b]||(a[b]="b2_"+_counter++),a[b]}function _extendModule(a,b){var c=a.prototype,d=a.toString().slice(1,-1);for(var e in b){var f=b[e],g="";c[e]||(e==e.toUpperCase()?g="var "+e+"="+d+"."+e+";":"function"==typeof f&&f.call&&(g="var "+e+"=base2.lang.bind('"+e+"',"+d+");",c[e]=_createModuleMethod(a,e),c[e]._module=a),-1==a.namespace.indexOf(g)&&(a.namespace+=g))}}function _createStaticModuleMethod(a,b){return function(){return a[b].apply(a,arguments)}}function _createModuleMethod(a,b){return function(){var c=_slice.call(arguments);return c.unshift(this),a[b].apply(a,c)}}function assert(a,b,c){if(!a)throw new(c||Error)(b||"Assertion failed.")}function assertArity(a,b,c){if(null==b&&(b=a.callee.length),a.length<b)throw new SyntaxError(c||"Not enough arguments.")}function assertType(a,b,c){if(b&&("function"==typeof b?!instanceOf(a,b):typeOf(a)!=b))throw new TypeError(c||"Invalid type.")}function copy(a){var b={};for(var c in a)b[c]=a[c];return b}function pcopy(a){return _dummy.prototype=a,new _dummy}function _dummy(){}function extend(a,b){if(a&&b){var c=base2.__prototyping;if(arguments.length>2){var d=b;b={},b[d]=arguments[2],c=!0}var e=global["function"==typeof b?"Function":"Object"].prototype;if(c)for(var d,f=_HIDDEN.length;d=_HIDDEN[--f];){var g=b[d];g!=e[d]&&(_BASE.test(g)?a[d]=_override(a,d,g):a[d]=g)}for(d in b)if("undefined"==typeof e[d]&&(g=b[d],g!=_IGNORE)){var h=a[d];h&&"function"==typeof g?g!=h&&(_BASE.test(g)?a[d]=_override(a,d,g):(g.ancestor=h,a[d]=g)):a[d]=g}}return a}function _ancestorOf(a,b){for(;b;){if(!b.ancestor)return!1;if(b=b.ancestor,b==a)return!0}return!1}function _override(a,b,c){function d(){var a=this.base;this.base=f?f[b]:e;var d=c.apply(this,arguments);return this.base=a,d}var e=a[b],f=base2.__prototyping;return f&&e!=f[b]&&(f=null),d.method=c,d.ancestor=e,d.toString=K(c+""),d}function forEach(a,b,c,d){if(null!=a){if(!d)if("function"==typeof a&&a.call)d=Function;else{if("function"==typeof a.forEach&&a.forEach!=forEach)return void a.forEach(b,c);if("number"==typeof a.length)return void _Array_forEach(a,b,c)}_Function_forEach(d||Object,a,b,c)}}function _Array_forEach(a,b,c){null==a&&(a=global);var d,e=a.length||0;if("string"==typeof a)for(d=0;e>d;d++)b.call(c,a.charAt(d),d,a);else for(d=0;e>d;d++)d in a&&b.call(c,a[d],d,a)}function _Function_forEach(a,b,c,d){var e=function(){this.i=1};e.prototype={i:1};var f=0;for(var g in new e)f++;(_Function_forEach=f>1?function(a,b,c,d){var e={};for(var f in b)e[f]||void 0!==a.prototype[f]||(e[f]=!0,c.call(d,b[f],f,b))}:function(a,b,c,d){for(var e in b)"undefined"==typeof a.prototype[e]&&c.call(d,b[e],e,b)})(a,b,c,d)}function instanceOf(a,b){if("function"!=typeof b)throw new TypeError("Invalid 'instanceOf' operand.");if(null==a)return!1;if(a.constructor==b)return!0;if(b.ancestorOf)return b.ancestorOf(a.constructor);if(a instanceof b)return!0;if(Base.ancestorOf==b.ancestorOf)return!1;if(Base.ancestorOf==a.constructor.ancestorOf)return b==Object;switch(b){case Array:return"[object Array]"==_toString.call(a);case Date:return"[object Date]"==_toString.call(a);case RegExp:return"[object RegExp]"==_toString.call(a);case Function:return"function"==typeOf(a);case String:case Number:case Boolean:return typeOf(a)==typeof b.prototype.valueOf();case Object:return!0}return!1}function typeOf(a){var b=typeof a;switch(b){case"object":return null==a?"null":"function"==typeof a.constructor&&"[object Date]"!=_toString.call(a)?typeof a.constructor.prototype.valueOf():b;case"function":return"function"==typeof a.call?b:"object";default:return b}}function _createObject2(a,b,c,d){var e=Module.extend(),f=e.toString().slice(1,-1);forEach.csv(c,function(b){e[b]=unbind(a.prototype[b]),e.namespace+=format("var %1=%2.%1;",b,f)}),forEach(_slice.call(arguments,3),e.implement,e);var g=function(){return e(this.constructor==e?b.apply(null,arguments):arguments[0])};g.prototype=e.prototype;for(var h in e){var i=a[h];i&&"prototype"!=h&&"toString"!=h&&i!=Function.prototype[h]&&(e[h]=i,delete e.prototype[h]),g[h]=e[h]}return g.ancestor=Object,delete g.extend,g.namespace=g.namespace.replace(/(var (\w+)=)[^,;]+,([^\)]+)\)/g,"$1$3.$2"),g}function trim(a){return String(a).replace(_LTRIM,"").replace(_RTRIM,"")}function csv(a){return a?(a+"").split(/\s*,\s*/):[]}function format(a){var b=arguments,c=new RegExp("%([1-"+(arguments.length-1)+"])","g");return(a+"").replace(c,function(a,c){return b[c]})}function match(a,b){return(a+"").match(b)||[]}function rescape(a){return(a+"").replace(_RESCAPE,"\\$1")}function I(a){return a}function II(a,b){return b}function K(a){return function(){return a}}function bind(a,b){var c="function"!=typeof a;if(arguments.length>2){var d=_slice.call(arguments,2);return function(){return(c?b[a]:a).apply(b,d.concat.apply(d,arguments))}}return function(){return(c?b[a]:a).apply(b,arguments)}}function compose(){var a=_slice.call(arguments);return function(){for(var b=a.length,c=a[--b].apply(this,arguments);b--;)c=a[b].call(this,c);return c}}function delegate(a,b){return function(){var c=_slice.call(arguments);return c.unshift(this),a.apply(b,c)}}function flip(a){return function(){return a.apply(this,Array2.swap(arguments,0,1))}}function not(a){return function(){return!a.apply(this,arguments)}}function partial(a){var b=_slice.call(arguments,1);return function(){for(var c=b.concat(),d=0,e=0;d<b.length&&e<arguments.length;)void 0===c[d]&&(c[d]=arguments[e++]),d++;for(;e<arguments.length;)c[d++]=arguments[e++];return Array2.contains(c,void 0)?(c.unshift(a),partial.apply(null,c)):a.apply(this,c)}}function unbind(a){return function(b){return a.apply(b,_slice.call(arguments,1))}}var Undefined=K(),Null=K(null),True=K(!0),False=K(!1),This=function(){return this},global=This(),base2=global.base2,_IGNORE=K(),_FORMAT=/%([1-9])/g,_LTRIM=/^\s\s*/,_RTRIM=/\s\s*$/,_RESCAPE=/([\/()[\]{}|*+-.,^$?\\])/g,_BASE=/\bbase\b/,_HIDDEN=["constructor","toString"],_counter=1,_slice=Array.prototype.slice;_Function_forEach();var _subclass=function(a,b){function c(){if(!base2.__prototyping){if(this.constructor!=c&&!this.__constructing){var a=arguments[0];if(a instanceof c)return a;var b=c;do if(b.coerce){var f=b.coerce.apply(c,arguments);if(f)return f}while((b=b.ancestor)&&b!=Base);return extend(a,d)}this.__constructing=!0;var g=e.apply(this,arguments);if(delete this.__constructing,g)return g}return this}base2.__prototyping=this.prototype;var d=new this;a&&extend(d,a),d.base=function(){},delete base2.__prototyping;var e=d.constructor;d.constructor=c;for(var f in Base)c[f]=this[f];return b&&extend(c,b),c.ancestor=this,c.ancestorOf=Base.ancestorOf,c.base=d.base,c.prototype=d,c.init&&c.init(),c["#implements"]=[],c["#implemented_by"]=[],c},Base=_subclass.call(Object,{constructor:function(){arguments.length>0&&this.extend(arguments[0])},extend:delegate(extend),toString:function(){return this.constructor.toString==Function.prototype.toString?"[object base2.Base]":"[object "+String2.slice(this.constructor,1,-1)+"]"}},Base={ancestorOf:function(a){return _ancestorOf(this,a)},extend:_subclass,forEach:function(a,b,c){_Function_forEach(this,a,b,c)},implement:function(a){return"function"==typeof a&&(_ancestorOf(Base,a)&&(this["#implements"].push(a),a["#implemented_by"].push(this)),a=a.prototype),extend(this.prototype,a),this}}),Package=Base.extend({constructor:function(a,b){function c(a){a=a.split(".");for(var b=base2,c=0;b&&null!=a[c];)b=b[a[c++]];return b}var d,e=this;if(e.extend(b),e.name&&"base2"!=e.name&&(void 0===b.parent&&(e.parent=base2),d=e.parent&&e.parent[e.name],d?e.namespace=d.namespace:(e.parent&&e.parent.addName(e.name,e),e.namespace=format("var %1=%2;",e.name,String2.slice(e,1,-1)))),a){for(var f,g=base2.js?base2.js.namespace:"",h="var base2=(function(){return this.base2})(),_private=base2.toString;"+base2.namespace+g,i=csv(e.imports),j=0;f=i[j];j++){var k=c(f)||c("js."+f);if(!k)throw new ReferenceError(format("Object not found: '%1'.",f));h+=k.namespace}d&&(h+=d.namespace),a.init=function(){e.init&&e.init()},a.imports=h+lang.namespace+"this.init();",h="";for(var l=d||e,m=csv(e.exports),j=0;f=m[j];j++){var n=e.name+"."+f;l.namespace+="var "+f+"="+n+";",h+="if(!"+n+")"+n+"="+f+";"}a.exports=h+"this._label_"+e.name+"();";var o=String2.slice(e,1,-1);a["_label_"+e.name]=function(){for(var a in l){var b=l[a];b&&b.ancestorOf==Base.ancestorOf&&"constructor"!=a&&(b.toString=K("["+o+"."+a+"]"))}}}return d?d:void 0},exports:"",imports:"",name:"",namespace:"",parent:null,open:function(a,b){return b.name=this.name,b.parent=this.parent,new Package(a,b)},addName:function(a,b){this[a]||(this[a]=b,this.exports+=","+a,this.namespace+=format("var %1=%2.%1;",a,this.name),b&&b.ancestorOf==Base.ancestorOf&&"constructor"!=a&&(b.toString=K("["+String2.slice(this,1,-1)+"."+a+"]")))},addPackage:function(a){var b=new Package(null,{name:a,parent:this});return this.addName(a,b),b},toString:function(){return format("[%1]",this.parent?String2.slice(this.parent,1,-1)+"."+this.name:this.name)}}),Abstract=Base.extend({constructor:function(){throw new TypeError("Abstract class cannot be instantiated.")}}),_moduleCount=0,Module=Abstract.extend(null,{namespace:"",extend:function(a,b){var c=this.base(),d=_moduleCount++;return c.namespace="",c.partial=this.partial,c.toString=K("[base2.Module["+d+"]]"),Module[d]=c,c.implement(this),a&&c.implement(a),b&&(extend(c,b),c.init&&c.init()),c},forEach:function(a,b){_Function_forEach(Module,this.prototype,function(c,d){"function"==typeOf(c)&&a.call(b,this[d],d,this)},this)},implement:function(a){var b=this,c=b.toString().slice(1,-1);if("function"==typeof a){if(_ancestorOf(a,b)||this.base(a),_ancestorOf(Module,a)){for(var d in a)if("undefined"==typeof b[d]){var e=a[d];"function"==typeof e&&e.call&&a.prototype[d]&&(e=_createStaticModuleMethod(a,d)),b[d]=e}b.namespace+=a.namespace.replace(/base2\.Module\[\d+\]/g,c)}}else extend(b,a),_extendModule(b,a);return b},partial:function(){var a=Module.extend(),b=a.toString().slice(1,-1);return a.namespace=this.namespace.replace(/(\w+)=b[^\)]+\)/g,"$1="+b+".$1"),this.forEach(function(b,c){a[c]=partial(bind(b,a))}),a}});Module.prototype.base=Module.prototype.extend=_IGNORE;var Enumerable=Module.extend({every:function(a,b,c){var d=!0;try{forEach(a,function(e,f){if(d=b.call(c,e,f,a),!d)throw StopIteration})}catch(e){if(e!=StopIteration)throw e}return!!d},filter:function(a,b,c){var d=0;return this.reduce(a,function(e,f,g){return b.call(c,f,g,a)&&(e[d++]=f),e},[])},invoke:function(a,b){var c=_slice.call(arguments,2);return this.map(a,"function"==typeof b?function(a){return null==a?void 0:b.apply(a,c)}:function(a){return null==a?void 0:a[b].apply(a,c)})},map:function(a,b,c){var d=[],e=0;return forEach(a,function(f,g){d[e++]=b.call(c,f,g,a)}),d},pluck:function(a,b){return this.map(a,function(a){return null==a?void 0:a[b]})},reduce:function(a,b,c,d){var e=arguments.length>2;return forEach(a,function(f,g){e?c=b.call(d,c,f,g,a):(c=f,e=!0)}),c},some:function(a,b,c){return!this.every(a,not(b),c)}}),_HASH="#",Map=Base.extend({constructor:function(a){a&&this.merge(a)},clear:function(){for(var a in this)0==a.indexOf(_HASH)&&delete this[a]},copy:function(){base2.__prototyping=!0;var a=new this.constructor;delete base2.__prototyping;for(var b in this)this[b]!==a[b]&&(a[b]=this[b]);return a},forEach:function(a,b){for(var c in this)0==c.indexOf(_HASH)&&a.call(b,this[c],c.slice(1),this)},get:function(a){return this[_HASH+a]},getKeys:function(){return this.map(II)},getValues:function(){return this.map(I)},has:function(a){return a=_HASH+a,a in this},merge:function(a){var b=flip(this.put);return forEach(arguments,function(a){forEach(a,b,this)},this),this},put:function(a,b){return this[_HASH+a]=b,b},remove:function(a){delete this[_HASH+a]},size:function(){var a=0;for(var b in this)0==b.indexOf(_HASH)&&a++;return a},union:function(a){return this.merge.apply(this.copy(),arguments)}});Map.implement(Enumerable),Map.prototype.filter=function(a,b){return this.reduce(function(c,d,e){return a.call(b,d,e,this)||c.remove(e),c},this.copy(),this)};var _KEYS="~",Collection=Map.extend({constructor:function(a){this[_KEYS]=new Array2,this.base(a)},add:function(a,b){if(this.has(a))throw"Duplicate key '"+a+"'.";return this.put.apply(this,arguments)},clear:function(){this.base(),this[_KEYS].length=0},copy:function(){var a=this.base();return a[_KEYS]=this[_KEYS].copy(),a},forEach:function(a,b){for(var c=this[_KEYS].concat(),d=c.length,e=0;d>e;e++)a.call(b,this[_HASH+c[e]],c[e],this)},getAt:function(a){var b=this[_KEYS].item(a);return void 0===b?void 0:this[_HASH+b]},getKeys:function(){return this[_KEYS].copy()},indexOf:function(a){return this[_KEYS].indexOf(String(a))},insertAt:function(a,b,c){if(null==this[_KEYS].item(a))throw"Index out of bounds.";if(this.has(b))throw"Duplicate key '"+b+"'.";return this[_KEYS].insertAt(a,String(b)),this[_HASH+b]=null,this.put.apply(this,_slice.call(arguments,1))},item:function(a){return this["number"==typeof a?"getAt":"get"](a)},put:function(a,b){var c=this.constructor;return c.Item&&!instanceOf(b,c.Item)&&(b=c.create.apply(c,arguments)),this.has(a)||this[_KEYS].push(String(a)),this[_HASH+a]=b,b},putAt:function(a,b){if(arguments[0]=this[_KEYS].item(a),null==arguments[0])throw"Index out of bounds.";return this.put.apply(this,arguments)},remove:function(a){this.has(a)&&(this[_KEYS].remove(String(a)),delete this[_HASH+a])},removeAt:function(a){var b=this[_KEYS].item(a);void 0!==b&&(this[_KEYS].removeAt(a),delete this[_HASH+b])},reverse:function(){return this[_KEYS].reverse(),this},size:function(){return this[_KEYS].length},slice:function(a,b){var c=this.copy();if(arguments.length>0){var d=this[_KEYS],e=d;c[_KEYS]=Array2(_slice.apply(d,arguments)),c[_KEYS].length&&(e=e.slice(0,a),arguments.length>1&&(e=e.concat(d.slice(b))));for(var f=0;f<e.length;f++)delete c[_HASH+e[f]]}return c},sort:function(a){return a?this[_KEYS].sort(bind(function(b,c){return a(this[_HASH+b],this[_HASH+c],b,c)},this)):this[_KEYS].sort(),this},toString:function(){return"("+(this[_KEYS]||"")+")"}},{Item:null,create:function(a,b){return this.Item?new this.Item(a,b):b},extend:function(a,b){var c=this.base(a);return c.create=this.create,b&&extend(c,b),c.Item?"function"!=typeof c.Item&&(c.Item=(this.Item||Base).extend(c.Item)):c.Item=this.Item,c.init&&c.init(),c}}),_RG_BACK_REF=/\\(\d+)/g,_RG_ESCAPE_CHARS=/\\./g,_RG_ESCAPE_BRACKETS=/\(\?[:=!]|\[[^\]]+\]/g,_RG_BRACKETS=/\(/g,_RG_LOOKUP=/\$(\d+)/,_RG_LOOKUP_SIMPLE=/^\$\d+$/,RegGrp=Collection.extend({constructor:function(a,b){this.base(a),this.ignoreCase=!!b},ignoreCase:!1,exec:function(a,b){a+="";var c=this,d=this[_KEYS];return d.length?(b==RegGrp.IGNORE&&(b=0),a.replace(new RegExp(this,this.ignoreCase?"gi":"g"),function(a){for(var e,f=1,g=0;e=c[_HASH+d[g++]];){var h=f+e.length+1;if(arguments[f]){var i=null==b?e.replacement:b;switch(typeof i){case"function":return i.apply(c,_slice.call(arguments,f,h));case"number":return arguments[f+i];default:return i}}f=h}return a})):a},insertAt:function(a,b,c){return instanceOf(b,RegExp)&&(arguments[1]=b.source),this.base.apply(this,arguments)},test:function(a){return this.exec(a)!=a},toString:function(){var a=1;return"("+this.map(function(b){var c=(b+"").replace(_RG_BACK_REF,function(b,c){return"\\"+(a+Number(c))});return a+=b.length+1,c}).join(")|(")+")"}},{IGNORE:"$0",init:function(){forEach("add,get,has,put,remove".split(","),function(a){this[a]=_override(this,a,function(a){return instanceOf(a,RegExp)&&(arguments[0]=a.source),this.base.apply(this,arguments)})},this.prototype)},Item:{constructor:function(a,b){if(null==b?b=RegGrp.IGNORE:null!=b.replacement?b=b.replacement:"function"!=typeof b&&(b=String(b)),"string"==typeof b&&_RG_LOOKUP.test(b))if(_RG_LOOKUP_SIMPLE.test(b))b=parseInt(b.slice(1),10);else{var c='"';b=b.replace(/\\/g,"\\\\").replace(/"/g,"\\x22").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\$(\d+)/g,c+"+(arguments[$1]||"+c+c+")+"+c).replace(/(['"])\1\+(.*)\+\1\1$/,"$1"),b=new Function("return "+c+b+c)}this.length=RegGrp.count(a),this.replacement=b,this.toString=K(a+"")},disabled:!1,length:0,replacement:""},count:function(a){return a=(a+"").replace(_RG_ESCAPE_CHARS,"").replace(_RG_ESCAPE_BRACKETS,""),match(a,_RG_BRACKETS).length}}),lang={name:"lang",version:base2.version,exports:"assert,assertArity,assertType,bind,copy,extend,forEach,format,instanceOf,match,pcopy,rescape,trim,typeOf",namespace:""};"undefined"==typeof StopIteration&&(StopIteration=new Error("StopIteration")),forEach.csv=function(a,b,c){forEach(csv(a),b,c)};var _toString=Object.prototype.toString,js={name:"js",version:base2.version,exports:"Array2,Date2,Function2,String2",namespace:"",bind:function(a){var b=global;return global=a,forEach.csv(this.exports,function(b){var c=b.slice(0,-1);extend(a[c],this[b]),this[b](a[c].prototype)},this),global=b,a}};(new Date).getYear()>1900&&(Date.prototype.getYear=function(){return this.getFullYear()-1900},Date.prototype.setYear=function(a){return this.setFullYear(a+1900)});var _testDate=new Date(Date.UTC(2006,1,20));_testDate.setUTCDate(15),0!=_testDate.getUTCHours()&&forEach.csv("FullYear,Month,Date,Hours,Minutes,Seconds,Milliseconds",function(a){extend(Date.prototype,"setUTC"+a,function(){var a=this.base.apply(this,arguments);return a>=57722401e3&&(a-=36e5,this.setTime(a)),a})}),Function.prototype.prototype={},"$"=="".replace(/^/,K("$$"))&&extend(String.prototype,"replace",function(a,b){if("function"==typeof b){var c=b;b=function(){return String(c.apply(null,arguments)).split("$").join("$$")}}return this.base(a,b)});var Array2=_createObject2(Array,Array,"concat,join,pop,push,reverse,shift,slice,sort,splice,unshift",Enumerable,{batch:function(a,b,c,d,e){var f=0,g=a.length,h=function(){for(var i=Date2.now(),j=i,k=0;g>f&&c>i-j;)b.call(e,a[f],f++,a),(k++<5||k%50==0)&&(i=Date2.now());g>f?setTimeout(h,10):d&&d.call(e)};setTimeout(h,1)},combine:function(a,b){return b||(b=a),Array2.reduce(a,function(a,c,d){return a[c]=b[d],a},{})},contains:function(a,b){return-1!=Array2.indexOf(a,b)},copy:function(a){var b=_slice.call(a);return b.swap||Array2(b),b},flatten:function(a){var b=0,c=function(a,d){return Array2.like(d)?Array2.reduce(d,c,a):a[b++]=d,a};return Array2.reduce(a,c,[])},forEach:_Array_forEach,indexOf:function(a,b,c){var d=a.length;null==c?c=0:0>c&&(c=Math.max(0,d+c));for(var e=c;d>e;e++)if(a[e]===b)return e;return-1},insertAt:function(a,b,c){Array2.splice(a,b,0,c)},item:function(a,b){return 0>b&&(b+=a.length),a[b]},lastIndexOf:function(a,b,c){var d=a.length;null==c?c=d-1:0>c&&(c=Math.max(0,d+c));for(var e=c;e>=0;e--)if(a[e]===b)return e;return-1},map:function(a,b,c){var d=[];return _Array_forEach(a,function(e,f){d[f]=b.call(c,e,f,a)}),d},remove:function(a,b){var c=Array2.indexOf(a,b);-1!=c&&Array2.removeAt(a,c)},removeAt:function(a,b){Array2.splice(a,b,1)},swap:function(a,b,c){0>b&&(b+=a.length),0>c&&(c+=a.length);var d=a[b];return a[b]=a[c],a[c]=d,a}});Array2.forEach=_Array_forEach,Array2.reduce=Enumerable.reduce,Array2.like=function(a){return"object"==typeOf(a)&&"number"==typeof a.length},Enumerable["#implemented_by"].pop(),Enumerable["#implemented_by"].push(Array2);var _DATE_PATTERN=/^((-\d+|\d{4,})(-(\d{2})(-(\d{2}))?)?)?T((\d{2})(:(\d{2})(:(\d{2})(\.(\d{1,3})(\d)?\d*)?)?)?)?(([+-])(\d{2})(:(\d{2}))?|Z)?$/,_DATE_PARTS={FullYear:2,Month:4,Date:6,Hours:8,Minutes:10,Seconds:12,Milliseconds:14},_TIMEZONE_PARTS={Hectomicroseconds:15,UTC:16,Sign:17,Hours:18,Minutes:20},Date2=_createObject2(Date,function(a,b,c,d,e,f,g){switch(arguments.length){case 0:return new Date;case 1:return new Date("string"==typeof a?Date2.parse(a):a.valueOf());default:return new Date(a,b,2==arguments.length?1:c,d||0,e||0,f||0,g||0)}},"",{toISOString:function(a){var b="####-##-##T##:##:##.###";for(var c in _DATE_PARTS)b=b.replace(/#+/,function(b){var d=a["getUTC"+c]();return"Month"==c&&d++,("000"+d).slice(-b.length)});return b+"Z"}});delete Date2.forEach,Date2.now=function(){return(new Date).valueOf()},Date2.parse=function(a,b){arguments.length>1&&assertType(b,"number","Default date should be of type 'number'.");var c=match(a,_DATE_PATTERN);if(c.length){var d=c[_DATE_PARTS.Month];d&&(c[_DATE_PARTS.Month]=String(d-1)),c[_TIMEZONE_PARTS.Hectomicroseconds]>=5&&c[_DATE_PARTS.Milliseconds]++;var e=c[_TIMEZONE_PARTS.UTC]||c[_TIMEZONE_PARTS.Hours]?"UTC":"",f=new Date(b||0);c[_DATE_PARTS.Date]&&f["set"+e+"Date"](14);for(var g in _DATE_PARTS){var h=c[_DATE_PARTS[g]];if(h&&(f["set"+e+g](h),f["get"+e+g]()!=c[_DATE_PARTS[g]]))return 0/0}if(c[_TIMEZONE_PARTS.Hours]){var i=Number(c[_TIMEZONE_PARTS.Sign]+c[_TIMEZONE_PARTS.Hours]),j=Number(c[_TIMEZONE_PARTS.Sign]+(c[_TIMEZONE_PARTS.Minutes]||0));f.setUTCMinutes(f.getUTCMinutes()+60*i+j)}return f.valueOf()}return Date.parse(a)};var String2=_createObject2(String,function(a){return new String(0==arguments.length?"":a)},"charAt,charCodeAt,concat,indexOf,lastIndexOf,match,replace,search,slice,split,substr,substring,toLowerCase,toUpperCase",{csv:csv,format:format,rescape:rescape,trim:trim});delete String2.forEach;var Function2=_createObject2(Function,Function,"",{I:I,II:II,K:K,bind:bind,compose:compose,delegate:delegate,flip:flip,not:not,partial:partial,unbind:unbind});base2=global.base2=new Package(this,base2),base2.toString=K("[base2]");var _exports=this.exports;lang=new Package(this,lang),_exports+=this.exports,js=new Package(this,js),eval(_exports+this.exports),lang.extend=extend,base2.JavaScript=pcopy(js),base2.JavaScript.namespace+="var JavaScript=js;","undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(exports=module.exports=base2),exports.base2=base2)};var miruken=require("./miruken.js"),Promise=require("bluebird");!new function(){function $define(a,b){function c(a,b,c,e){return b instanceof Array?Array2.reduce(b,function(b,f){var g=d(a,f,c,e);return function(a){b(a),g(a)}},Undefined):d(a,b,c,e)}function d(b,c,d,e){if($isNothing(b))throw new TypeError("Definitions must have an owner.");if($isNothing(d)&&(d=c,c=$classOf(Modifier.unwrap(c))),$isNothing(d))throw new TypeError(lang.format("Incomplete '%1' definition: missing handler for constraint %2.",a,c));if(e&&!$isFunction(e))throw new TypeError("The removed argument is not a function.");if(!$isFunction(d))if($copy.test(d)){var f=Modifier.unwrap(d);if(!$isFunction(f.copy))throw new Error("$copy requires the target to have a copy method.");d=f.copy.bind(f)}else{var f=$use.test(d)?Modifier.unwrap(d):d;d=$lift(f)}var h=b.$meta,i=new _Node(c,d,e),j=_createIndex(i.constraint),k=h[a]||(h[a]=new IndexedList(g));return k.insert(i,j),function(c){k.remove(i),k.isEmpty()&&delete h[a],i.removed&&c!==!1&&i.removed(b)}}function e(b,c,d,g,h,i,j,k){for(var l=!1;c&&c!==Base&&c!==Object;){var m=c.$meta,n=_createIndex(g),o=m&&m[a],p=h===Variance.Invariant;if(c=c===b?$classOf(c):$ancestorOf(c),o&&(!p||n))for(var q=o.getIndex(n)||o.head;q;){if(q.match(g,h)){var r=b.base,s=!1;b.base=function(){var a;return s=!0,e(b,c,d,g,h,i,!1,function(b){a=b}),a};try{var t=q.handler.call(b,d,i);if(f(t)){if(k&&k.call(d,t),!j)return!0;l=!0}else if(s&&!j)return!1}finally{b.base=r}}else if(p)break;q=q.next}}return l}if(!$isString(a)||0===a.length||/\s/.test(a))throw new TypeError("The tag must be a non-empty string with no whitespace.");if(_definitions[a])throw new TypeError(lang.format("'%1' is already defined.",a));var f,g;switch(b=b||Variance.Contravariant){case Variance.Covariant:f=_resultRequired,g=_covariantComparer;break;case Variance.Contravariant:f=_successImplied,g=_contravariantComparer;break;case Variance.Invariant:f=_resultRequired,g=_invariantComparer;break;default:throw new Error("Variance must be Covariant, Contravariant or Invariant")}return c.removeAll=function(b){for(var c=b.$meta,d=c[a],e=d.head;e;)e.removed&&e.removed(b),e=e.next;delete c[a]},c.dispatch=function(a,c,d,f,g,h){var i=b,j=a.getDelegate();d=d||c,d&&($eq.test(d)&&(i=Variance.Invariant),d=Modifier.unwrap(d),"object"===typeOf(d)&&(d=$classOf(d)));var k=e(j,j,c,d,i,f,g,h);return(!k||g)&&(k=k||e(a,a,c,d,i,f,g,h)),k},_definitions[a]=c,c}function _Node(a,b,c){var d=$eq.test(a);a=Modifier.unwrap(a),this.constraint=a,this.handler=b,$isNothing(a)?this.match=d?False:_matchEverything:$isProtocol(a)?this.match=d?_matchInvariant:_matchProtocol:$isClass(a)?this.match=d?_matchInvariant:_matchClass:$isString(a)?this.match=_matchString:instanceOf(a,RegExp)?this.match=d?False:_matchRegExp:$isFunction(a)?this.match=a:this.match=False,c&&(this.removed=c)}function _createIndex(a){if(a){if($isString(a))return a;if($isFunction(a))return assignID(a)}}function _matchInvariant(a){return this.constraint===a}function _matchEverything(a,b){return b!==Variance.Invariant}function _matchProtocol(a,b){var c=this.constraint;return c===a?!0:b===Variance.Covariant?c.conformsTo(a):b===Variance.Contravariant?a.conformsTo&&a.conformsTo(c):!1}function _matchClass(a,b){var c=this.constraint;return c===a?!0:b===Variance.Contravariant?a.prototype instanceof c:b===Variance.Covariant?a.prototype&&(c.prototype instanceof a||$isProtocol(a)&&a.adoptedBy(c)):!1}function _matchString(a){return $isString(a)&&this.constraint==a}function _matchRegExp(a,b){return b!==Variance.Invariant&&this.constraint.test(a)}function _covariantComparer(a,b){return b.match(a.constraint,Variance.Invariant)?0:b.match(a.constraint,Variance.Covariant)?-1:1}function _contravariantComparer(a,b){return b.match(a.constraint,Variance.Invariant)?0:b.match(a.constraint,Variance.Contravariant)?-1:1}function _invariantComparer(a,b){return b.match(a.constraint,Variance.Invariant)?0:-1}function _resultRequired(a){return null!==a&&void 0!==a&&a!==$NOT_HANDLED}function _successImplied(a){return a?a!==$NOT_HANDLED:void 0===a}function getEffectivePromise(a){return a instanceof HandleMethod&&(a=a.getReturnValue()),$isPromise(a)?a:null}var callback=new base2.Package(this,{name:"callback",version:miruken.version,parent:miruken,imports:"miruken",exports:"CallbackHandler,CallbackHandlerDecorator,CallbackHandlerFilter,CallbackHandlerAspect,CascadeCallbackHandler,CompositeCallbackHandler,ConditionalCallbackHandler,AcceptingCallbackHandler,ProvidingCallbackHandler,MethodCallbackHandler,InvocationOptions,Resolution,HandleMethod,getEffectivePromise,$handle,$callbacks,$define,$provide,$lookup,$NOT_HANDLED"});eval(this.imports);var _definitions={},$handle=$define("$handle",Variance.Contravariant),$provide=$define("$provide",Variance.Covariant),$lookup=$define("$lookup",Variance.Invariant),$NOT_HANDLED={},InternalCallback=Protocol.extend(),$callbacks=MetaMacro.extend({apply:function(a,b,c,d){if(!$isNothing(d)){var e=b.getClass();c===e.prototype&&(c=e);for(tag in _definitions){var f=null;if(d.hasOwnProperty(tag)&&(f=d[tag],delete d[tag],delete c[tag]),$isFunction(f)&&(f=f()),f&&0!=f.length)for(var g=_definitions[tag],h=0;h<f.length;++h){var i=f[h];if(++h>=f.length)throw new Error(lang.format("Incomplete '%1' definition: missing handler for constraint %2.",tag,i));g(c,i,f[h])}}}},shouldInherit:True,isActive:True}),HandleMethod=Base.extend({constructor:function(a,b,c,d){if(a&&!$isProtocol(a))throw new TypeError("Invalid protocol supplied.");var e,f;this.extend({getProtocol:function(){return a},getMethodName:function(){return b},getArguments:function(){return c},getReturnValue:function(){return e},setReturnValue:function(a){e=a},getException:function(){return f},invokeOn:function(g,h){if(!g||d&&a&&!a.adoptedBy(g))return!1;var i=g[b];if(!$isFunction(i))return!1;try{var j=global.$composer;global.$composer=h;var k=i.apply(g,c.slice(0));if(k===$NOT_HANDLED)return!1;void 0===e&&(e=k)}catch(l){throw void 0===e&&void 0===f&&(f=l),l}finally{j?global.$composer=j:delete global.$composer}return!0}})}}),Lookup=Base.extend({constructor:function(a,b){if($isNothing(a))throw new TypeError("The key is required.");b=!!b;var c=[],d=$instant.test(a);this.extend({getKey:function(){return a},isMany:function(){return b},getResults:function(){return c},addResult:function(a){d&&$isPromise(a)||c.push(a)}})}}),Deferred=Base.extend({constructor:function(a,b){if($isNothing(a))throw new TypeError("The callback is required.");b=!!b;var c=[];this.extend({isMany:function(){return b},getCallback:function(){return a},getPending:function(){
return c},track:function(a){$isPromise(a)&&c.push(a)}})}}),Resolution=Base.extend({constructor:function(a,b){if($isNothing(a))throw new TypeError("The key is required.");b=!!b;var c=[],d=$instant.test(a);this.extend({getKey:function(){return a},isMany:function(){return b},getResolutions:function(){return c},resolve:function(a){d&&$isPromise(a)||c.push(a)}})}}),CallbackHandler=Base.extend($callbacks,{constructor:function(a){this.extend({getDelegate:function(){return a}})},getDelegate:function(){return null},handle:function(a,b,c){return!$isNothing(a)&&!!this.handleCallback(a,!!b,c||this)},handleCallback:function(a,b,c){return $handle.dispatch(this,a,null,c,b)},$handle:[Lookup,function(a,b){return $lookup.dispatch(this,a,a.getKey(),b,a.isMany(),a.addResult)},Deferred,function(a,b){return $handle.dispatch(this,a.getCallback(),null,b,a.isMany(),a.track)},Resolution,function(a,b){var c=a.getKey(),d=a.isMany(),e=$provide.dispatch(this,a,c,b,d,a.resolve);if(!e){var f=new _Node(c),g=this.getDelegate();g&&f.match($classOf(g),Variance.Contravariant)&&(a.resolve(g),e=!0),e&&!d||!f.match($classOf(this),Variance.Contravariant)||(a.resolve(this),e=!0)}return e},HandleMethod,function(a,b){return a.invokeOn(this.getDelegate(),b)||a.invokeOn(this,b)}],toDelegate:function(){return new InvocationDelegate(this)}},{coerce:function(a){return new this(a)}});Base.implement({toCallbackHandler:function(){return CallbackHandler(this)}});var CallbackHandlerDecorator=CallbackHandler.extend({constructor:function(a){if($isNothing(a))throw new TypeError("No decoratee specified.");this.extend({getDecoratee:function(){return a},setDecoratee:function(b){a=b.toCallbackHandler()},handleCallback:function(a,b,c){return this.getDecoratee().handle(a,b,c)||this.base(a,b,c)}}),this.setDecoratee(a)}}),CallbackHandlerFilter=CallbackHandlerDecorator.extend({constructor:function(a,b){if(this.base(a),$isNothing(b))throw new TypeError("No filter specified.");if(!$isFunction(b))throw new TypeError(lang.format("Invalid filter: %1 is not a function.",b));this.extend({handleCallback:function(a,c,d){var e=this.getDecoratee();return InternalCallback.adoptedBy(a)?e.handle(a,c):(d==this&&(d=e),b(a,d,function(){return e.handle(a,c)}))}})}}),CallbackHandlerAspect=CallbackHandlerFilter.extend({constructor:function(a,b,c){this.base(a,function(a,d,e){var f;if($isFunction(b)&&b(a,d)===!1)return!0;try{var g=e();if(g&&(f=getEffectivePromise(a)))return $isFunction(c)&&f.then(function(b){c(a,d)},function(b){c(a,d)}),g}finally{!f&&$isFunction(c)&&c(a,d)}})}}),CascadeCallbackHandler=CallbackHandler.extend({constructor:function(a,b){if($isNothing(a))throw new TypeError("No handler specified.");if($isNothing(b))throw new TypeError("No cascadeToHandler specified.");a=a.toCallbackHandler(),b=b.toCallbackHandler(),this.extend({handleCallback:function(c,d,e){var f=d?a.handle(c,!0,e)|b.handle(c,!0,e):a.handle(c,!1,e)||b.handle(c,!1,e);return(!f||d)&&(f=this.base(c,d,e)||f),!!f}})}}),CompositeCallbackHandler=CallbackHandler.extend({constructor:function(){var a=new Array2;this.extend({getHandlers:function(){return a.copy()},addHandlers:function(){return Array2.flatten(arguments).forEach(function(b){b&&a.push(b.toCallbackHandler())}),this},removeHandlers:function(){return Array2.flatten(arguments).forEach(function(b){if(b)for(var c=a.length,d=0;c>d;++d){var e=a[d];if(e==b||e.getDelegate()==b)return void a.removeAt(d)}}),this},handleCallback:function(b,c,d){for(var e=!1,f=a.length,g=0;f>g;++g){var h=a[g];if(h.handle(b,c,d)){if(!c)return!0;e=!0}}return(!e||c)&&(e=this.base(b,c,d)||e),e}}),this.addHandlers(arguments)}}),ConditionalCallbackHandler=CallbackHandlerDecorator.extend({constructor:function(a,b){if(this.base(a),$isNothing(b))throw new TypeError("No condition specified.");if(!$isFunction(b))throw new TypeError(lang.format("Invalid condition: %1 is not a function.",b));this.extend({handleCallback:function(a,c,d){return b(a)?this.base(a,c,d):!1}})}}),AcceptingCallbackHandler=CallbackHandler.extend({constructor:function(a,b){$handle(this,b,a)}});void 0===Function.prototype.accepting&&(Function.prototype.accepting=function(a){return new AcceptingCallbackHandler(this,a)}),CallbackHandler.accepting=function(a,b){return new AcceptingCallbackHandler(a,b)};var ProvidingCallbackHandler=CallbackHandler.extend({constructor:function(a,b){$provide(this,b,a)}});void 0===Function.prototype.providing&&(Function.prototype.providing=function(a){return new ProvidingCallbackHandler(this,a)}),CallbackHandler.providing=function(a,b){return new ProvidingCallbackHandler(a,b)};var MethodCallbackHandler=CallbackHandler.extend({constructor:function(a,b){if(!$isString(a)||0===a.length||!a.trim())throw new TypeError("No methodName specified.");if(!$isFunction(b))throw new TypeError(lang.format("Invalid method: %1 is not a function.",b));this.extend({handleCallback:function(c,d,e){if(c instanceof HandleMethod){var f=new Object;return f[a]=b,c.invokeOn(f)}return!1}})}});void 0===Function.prototype.implementing&&(Function.prototype.implementing=function(a){return new MethodCallbackHandler(a,this)}),CallbackHandler.implementing=function(a,b){return new MethodCallbackHandler(a,b)};var InvocationOptions={None:0,Broadcast:1,BestEffort:2,Strict:4};InvocationOptions.Notify=InvocationOptions.Broadcast|InvocationOptions.BestEffort,InvocationOptions=Enum(InvocationOptions);var InvocationSemantics=Base.extend(InternalCallback,{constructor:function(a){var b=a||InvocationOptions.None,c=b;this.extend({getOption:function(a){return(b&a)===a},setOption:function(a,d){d?b|=a:b&=~a,c|=a},isSpecified:function(a){return(c&a)===a},mergeInto:function(a){for(var b=0;2>=b;++b){var c=1<<b;this.isSpecified(c)&&!a.isSpecified(c)&&a.setOption(c,this.getOption(c))}}})}}),InvocationOptionsHandler=CallbackHandler.extend({constructor:function(a,b){var c=new InvocationSemantics(b);this.extend({handleCallback:function(b,d,e){return b instanceof InvocationSemantics?(c.mergeInto(b),!0):a.handle(b,d,e)}})}}),InvocationDelegate=Delegate.extend({constructor:function(a){this.extend({delegate:function(b,c,d,e){var f=new InvocationSemantics;a.handle(f,!0);var g=f.getOption(InvocationOptions.Broadcast),h=f.getOption(InvocationOptions.BestEffort),e=!!(e|f.getOption(InvocationOptions.Strict)),i=new HandleMethod(b,c,d,e);if(a.handle(i,!!g)===!1&&!h)throw new TypeError(lang.format("Object %1 has no method '%2'",a,c));return i.getReturnValue()}})}});CallbackHandler.implement({strict:function(){return this.callOptions(InvocationOptions.Strict)},broadcast:function(){return this.callOptions(InvocationOptions.Broadcast)},bestEffort:function(){return this.callOptions(InvocationOptions.BestEffort)},notify:function(){return this.callOptions(InvocationOptions.Notify)},callOptions:function(a){return new InvocationOptionsHandler(this,a)}}),CallbackHandler.implement({defer:function(a){var b=new Deferred(a);return this.handle(b,!1,global.$composer)?Promise.all(b.getPending())["return"](!0):Promise.resolve(!1)},deferAll:function(a){var b=new Deferred(a,!0);return this.handle(b,!0,global.$composer)?Promise.all(b.getPending())["return"](!0):Promise.resolve(!1)},resolve:function(a){var b=a instanceof Resolution?a:new Resolution(a);if(this.handle(b,!1,global.$composer)){var c=b.getResolutions();if(c.length>0)return c[0]}},resolveAll:function(a){var b=a instanceof Resolution?a:new Resolution(a,!0);if(this.handle(b,!0,global.$composer)){var c=b.getResolutions();if(c.length>0)return $instant.test(a)?Array2.flatten(c):Promise.all(c).then(Array2.flatten)}return[]},lookup:function(a){var b=a instanceof Lookup?a:new Lookup(a);if(this.handle(b,!1,global.$composer)){var c=b.getResults();if(c.length>0)return c[0]}},lookupAll:function(a){var b=a instanceof Lookup?a:new Lookup(a,!0);if(this.handle(b,!0,global.$composer)){var c=b.getResults();if(c.length>0)return $instant.test(a)?Array2.flatten(resolutions):Promise.all(c).then(Array2.flatten)}return[]},filter:function(a){return new CallbackHandlerFilter(this,a)},aspect:function(a,b){return new CallbackHandlerAspect(this,a,b)},when:function(a){var b=new _Node(a),c=function(a){return a instanceof Deferred?b.match($classOf(a.getCallback()),Variance.Contravariant):a instanceof Resolution?b.match(a.getKey(),Variance.Covariant):b.match($classOf(a),Variance.Contravariant)};return new ConditionalCallbackHandler(this,c)},next:function(){switch(arguments.length){case 0:return this;case 1:return new CascadeCallbackHandler(this,arguments[0]);default:return new CompositeCallbackHandler((Array2.unshift(arguments,this),arguments))}}}),"undefined"!=typeof module&&module.exports&&(module.exports=exports=callback),eval(this.exports)};var miruken=require("./miruken.js");require("./callback.js"),new function(){function _newContextTraversal(a,b){function c(){for(var c in a)if(!(c in Base.prototype)){var d=a[c];$isFunction(d)&&(this[c]=function(b,c){return function(){var d=b in CallbackHandler.prototype?this:a,e=c.apply(d,arguments);return e===a?e=this:e&&$isFunction(e.getDecoratee)&&$isFunction(e.setDecoratee)&&e.getDecoratee()==a&&e.setDecoratee(this),e}}(c,d))}this.extend({handle:function(a,c,d){return this.handleAxis(b,a,c,d)}})}return c.prototype=a.constructor.prototype,new c}var context=new base2.Package(this,{name:"context",version:miruken.version,parent:miruken,imports:"miruken,miruken.callback",exports:"ContextState,ContextObserver,Context,Contextual,ContextualMixin,ContextualHelper,$contextual"});eval(this.imports);var ContextState=Enum({Active:1,Ending:2,Ended:3}),ContextObserver=Protocol.extend({contextEnding:function(a){},contextEnded:function(a){},childContextEnding:function(a){},childContextEnded:function(a){}}),Context=CompositeCallbackHandler.extend(Parenting,Traversing,Disposing,TraversingMixin,{constructor:function(a){function b(){if(d!=ContextState.Active)throw new Error("The context has already ended.")}this.base();var c,d=ContextState.Active,e=a,f=new Array2,g=this.handleCallback;this.extend({getState:function(){return d},getParent:function(){return e},getChildren:function(){return f.copy()},hasChildren:function(){return f.length>0},getRoot:function(){for(var a=this;a&&a.getParent();)a=a.getParent();return a},newChild:function(){b();var a=new($classOf(this))(this).extend({end:function(){c&&c.invoke("childContextEnding",a),f.remove(a),this.base(),c&&c.invoke("childContextEnded",a)}});return f.push(a),a},store:function(a){$isSomething(a)&&$provide(this,a)},handleCallback:function(a,b,c){var d=this.base(a,b,c);return d&&!b?d:(e&&(d|=e.handle(a,b,c)),!!d)},handleAxis:function(a,b,c,d){if(null===b||void 0===b)return!1;if(c=!!c,d=d||this,a==TraversingAxis.Self)return g.call(this,b,c,d);var e=!1;return this.traverse(a,function(a){return e|=a.handleAxis(TraversingAxis.Self,b,c,d),e&&!c}),!!e},observe:function(a){return b(),null!==a&&void 0!==a?(a=ContextObserver(a),(c||(c=new Array2)).push(a),function(){c.remove(a)}):void 0},unwindToRootContext:function(){for(var a=this;a;){if(null==a.getParent())return a.unwind(),a;a=a.getParent()}return null},unwind:function(){this.getChildren().invoke("end")},end:function(){d==ContextState.Active&&(d=ContextState.Ending,c&&c.invoke("contextEnding",this),this.unwind(),d=ContextState.Ended,c&&c.invoke("contextEnded",this),c=null)},dispose:function(){this.end()}})}}),Contextual=Protocol.extend({getContext:function(){},setContext:function(a){}}),ContextualMixin=Module.extend({getContext:function(a){return a.__context},setContext:function(a,b){a.__context!==b&&(a.__context&&a.__context.removeHandlers(a),b?(a.__context=b,b.addHandlers(a)):delete a.__context)},isActiveContext:function(a){return a.__context&&a.__context.getState()===ContextState.Active},endContext:function(a){a.__context&&a.__context.end()}}),$contextual=MetaMacro.extend({apply:function(a,b){if(a===MetaStep.Subclass){var c=b.getClass();c.$meta.addProtocol(Contextual),c.implement(ContextualMixin)}}}),ContextualHelper=Module.extend({resolveContext:function(a){return a?a instanceof Context?a:$isFunction(a.getContext)?a.getContext():null:null},requireContext:function(a){var b=ContextualHelper.resolveContext(a);if(!(b instanceof Context))throw new Error("The supplied object is not a Context or Contextual object.");return b},clearContext:function(a){if(a&&$isFunction(a.getContext)&&$isFunction(a.setContext)){var b=a.getContext();if(b)try{b.end()}finally{a.setContext(null)}}},bindContext:function(a,b,c){if(!a||!c&&$isFunction(a.getContext)&&a.getContext())return a;if(void 0===a.setContext)a=ContextualMixin(a);else if(!$isFunction(a.setContext))throw new Error("Unable to set the context on "+a+".");return a.setContext(ContextualHelper.resolveContext(b)),a},bindChildContext:function(a,b){var c;if(b){if($isFunction(b.getContext)&&(c=b.getContext(),c&&c.getState()===ContextState.Active))return c;for(var d=ContextualHelper.requireContext(a);d&&d.getState()!==ContextState.Active;)d=d.getParent();d&&(c=d.newChild(),ContextualHelper.bindContext(b,c,!0))}return c}});Context.implement({self:function(){return _newContextTraversal(this,TraversingAxis.Self)},root:function(){return _newContextTraversal(this,TraversingAxis.Root)},child:function(){return _newContextTraversal(this,TraversingAxis.Child)},sibling:function(){return _newContextTraversal(this,TraversingAxis.Sibling)},childOrSelf:function(){return _newContextTraversal(this,TraversingAxis.ChildOrSelf)},siblingOrSelf:function(){return _newContextTraversal(this,TraversingAxis.SiblingOrSelf)},ancestor:function(){return _newContextTraversal(this,TraversingAxis.Ancestor)},ancestorOrSelf:function(){return _newContextTraversal(this,TraversingAxis.AncestorOrSelf)},descendant:function(){return _newContextTraversal(this,TraversingAxis.Descendant)},descendantOrSelf:function(){return _newContextTraversal(this,TraversingAxis.DescendantOrSelf)},parentSiblingOrSelf:function(){return _newContextTraversal(this,TraversingAxis.ParentSiblingOrSelf)}}),void 0===Function.prototype.newInContext&&(Function.prototype.newInContext=function(){function a(){d.apply(this,b)}var b=Array.prototype.slice.call(arguments),c=b.shift(),d=this;a.prototype=d.prototype;var e=new a;return ContextualHelper.bindContext(e,c),e}),void 0===Function.prototype.newInChildContext&&(Function.prototype.newInChildContext=function(){function a(){d.apply(this,b)}var b=Array.prototype.slice.call(arguments),c=b.shift(),d=this;a.prototype=d.prototype;var e=new a;return ContextualHelper.bindChildContext(c,e),e}),"undefined"!=typeof module&&module.exports&&(module.exports=exports=context),eval(this.exports)};var miruken=require("./miruken.js"),prettyjson=require("prettyjson"),Promise=require("bluebird");require("./callback.js"),new function(){function formatJson(a){var b=prettyjson.render(a);return b=b.split("\n").join("\n    "),"    "+b}var error=new base2.Package(this,{name:"error",version:miruken.version,parent:miruken,imports:"miruken,miruken.callback",exports:"Errors,ErrorCallbackHandler"});eval(this.imports);var Errors=Protocol.extend({handleError:function(a,b){},handleException:function(a,b){},reportError:function(a,b){},reportException:function(a,b){}}),ErrorCallbackHandler=CallbackHandler.extend({handleError:function(a,b){return Promise.resolve(Errors($composer).reportError(a,b))},handleException:function(a,b){return Promise.resolve(Errors($composer).reportException(a,b))},reportError:function(a,b){return console.error(formatJson(a)),Promise.resolve()},reportException:function(a,b){return console.error(formatJson(a)),Promise.resolve()}});CallbackHandler.implement({recoverable:function(a){return new CallbackHandlerFilter(this,function(b,c,d){try{var e,f=d();return f&&(e=getEffectivePromise(b))&&(e=e.caught(function(b){return Errors(c).handleError(b,a)}),b instanceof HandleMethod&&b.setReturnValue(e)),f}catch(g){return Errors(c).handleException(g,a),!0}})},recover:function(a){return function(b){return Errors(this).handleError(b,a)}.bind(this)}}),"undefined"!=typeof module&&module.exports&&(module.exports=exports=error),eval(this.exports)},module.exports=require("./miruken.js"),require("./callback.js"),require("./context.js"),require("./error.js"),require("./validate"),require("./ioc");var miruken=require("../miruken.js"),Promise=require("bluebird");require("./ioc.js"),new function(){function $classes(a){if(a instanceof Package)return new FromPackageBuilder(a);throw new TypeError(lang.format("Unrecognized $classes from %1.",hint))}function _unregisterBatch(a){return function(){for(var b=0;b<a.length;++b)a[b]()}}function _addMatchingProtocols(a,b,c){for(var d=_toplevelProtocols(a),e=0;e<d.length;++e){var f=d[e];f.$meta.getAllProtocols().indexOf(b)>=0&&c.push(f)}}function _toplevelProtocols(a){for(var b=a.$meta.getAllProtocols(),c=b.slice(0),d=0;d<b.length;++d)for(var e=b[d].$meta.getAllProtocols(),f=0;f<e.length;++f)Array2.remove(c,e[f]);return c}var ioc=new base2.Package(this,{name:"ioc",version:miruken.version,parent:miruken,imports:"miruken,miruken.ioc",exports:"Installer,$classes"});eval(this.imports);var Installer=Base.extend(Registration,{register:function(a,b){}}),FromBuilder=Base.extend(Registration,{constructor:function(){var a;this.extend({getClasses:function(){return[]},basedOn:function(){return a=new BasedOnBuilder(this,Array2.flatten(arguments))},register:function(b,c){var d,e=this.getClasses();return d=a?Array2.filter(Array2.map(e,function(b){return a.builderForClass(b)}),function(a){return a}):Array2.map(Array2.filter(e,function(a){var b=a.member||a;return b.prototype instanceof Installer}),function(a){return new(a=a.member||a)}),Promise.all(b.register(d)).then(function(a){return _unregisterBatch(a)})}})}}),FromPackageBuilder=FromBuilder.extend(Registration,{constructor:function(a){this.base(),this.extend({getClasses:function(){var b=[];return a.getClasses(function(a){b.push(a)}),b}})}}),BasedOnBuilder=Base.extend(Registration,{constructor:function(a,b){var c,d,e;this.withKeys=new KeyBuilder(this),this.extend({"if":function(a){if(c){var b=c;c=function(c){return b(c)&&a(c)}}else c=a;return this},unless:function(a){if(d){var b=d;d=function(c){return b(c)||a(c)}}else d=a;return this},configure:function(a){if(e){var b=e;e=function(c){b(c),a(c)}}else e=a;return this},builderForClass:function(a){var f=[],g=a.member||a,h=a.name;if(!(c&&!c(g)||d&&d(g))){for(var i=0;i<b.length;++i){var j=b[i];if($isProtocol(j)){if(!j.adoptedBy(g))continue}else if($isClass(j)&&!(g.prototype instanceof j))continue;f.indexOf(j)<0&&f.push(j)}if(f.length>0||0===b.length){var k=this.withKeys.getKeys(g,f,h),l=$component(k).boundTo(g);return e&&e(l),l}}},register:function(b,c){return a.register(b,c)}})}}),KeyBuilder=Base.extend({constructor:function(a){function b(b){if(c){var d=c;c=function(a,c,e,f){d(a,c,e,f),b(a,c,e,f)}}else c=b;return a}var c;this.extend({self:function(){return b(function(a,b){a.push(b)})},basedOn:function(){return b(function(a,b,c){a.push.apply(a,c)})},anyService:function(){return b(function(a,b){var c=b.$meta.getAllProtocols();c.length>0&&a.push(c[0])})},allServices:function(){return b(function(a,b){a.push.apply(a,b.$meta.getAllProtocols())})},mostSpecificService:function(a){return b(function(b,c,d){if($isProtocol(a))_addMatchingProtocols(c,a,b);else for(var e=0;e<d.length;++e){var f=d[e];$isFunction(f)&&_addMatchingProtocols(c,f,b)}if(0===b.length)for(var e=0;e<d.length;++e){var f=d[e];if(f!==Base&&f!==Object)if($isProtocol(f)){if(f.adoptedBy(c)){b.push(f);break}}else if(c===f||c.prototype instanceof f){b.push(f);break}}})},name:function(a){return b(function(b,c,d,e){$isNothing(a)?e&&b.push(e):$isFunction(a)?(e=a(e))&&b.push(String(e)):b.push(String(a))})},getKeys:function(a,b,d){var e=[];return c&&c(e,a,b,d),e.length>0?e:void 0}})}});$classes.fromPackage=function(a){if(!(a instanceof Package))throw new TypeError(lang.format("$classes expected a Package, but received %1 instead.",a));return new FromPackageBuilder(a)},"undefined"!=typeof module&&module.exports&&(module.exports=exports=ioc),eval(this.exports)},module.exports=require("./ioc.js"),require("./config.js");var miruken=require("../miruken.js"),Promise=require("bluebird");require("../context.js"),require("../validate"),new function(){function _makeClassFactory(a){return function(b){return a["new"].apply(a,b[Facet.Parameters])}}function _makeProxyFactory(a){var b=$proxyBuilder.buildProxy(a);return function(a){return b["new"].call(b,a)}}function $component(a){return new ComponentBuilder(a)}function DependencyResolutionError(a,b){this.message=b,this.dependency=a,this.stack=(new Error).stack}function ComponentModelError(a,b,c){this.message=c||"The component model contains one or more errors",this.componentModel=a,this.validation=b,this.stack=(new Error).stack}function _registerHandler(a,b,c,d,e,f){return $provide(a,b,function g(b,h){return b instanceof DependencyResolution||(b=new DependencyResolution(b.getKey())),b.claim(g,c)?d.resolve(_activate.bind(a,c,e,f,b,h),h):$NOT_HANDLED},d.dispose.bind(d))}function _activate(a,b,c,d,e){function f(){return b.call(e,h)}var g=[],h={},i=$instant.test(d.getKey()),j=Container(e);for(var k in c){var l=c[k];if(!$isNothing(l)){for(var m=l.slice(0),n=0;n<m.length;++n){var o=m[n];if(void 0!==o){var p=o.test(DependencyModifiers.Use),q=o.test(DependencyModifiers.Lazy),r=o.test(DependencyModifiers.Promise),s=o.test(DependencyModifiers.Child),t=o.test(DependencyModifiers.Dynamic),u=o.getDependency();if(p||t||$isNothing(u))t&&$isFunction(u)&&(u=u(j)),s&&(u=_createChild(u)),r&&(u=Promise.resolve(u));else if(u===$$composer)u=e;else if(u===Container)u=j;else{var v=o.test(DependencyModifiers.Every),w=o.test(DependencyModifiers.Optional),x=o.test(DependencyModifiers.Invariant),y=o.test(DependencyModifiers.Container);if(x&&(u=$eq(u)),i&&(u=$instant(u)),q)u=function(a,b,c){return function(){if(!b){b=!0;var d=y?j:e;c=_resolveDependency(a,!1,r,s,v,d)}return c}}(u);else{var z=new DependencyResolution(u,d,v),A=y?j:e;u=_resolveDependency(z,!w,r,s,v,A),!r&&$isPromise(u)&&(g.push(u),function(a,b,c){a.then(function(a){b[c]=a})}(u,m,n))}}m[n]=u}}h[k]=m}}return 1===g.length?g[0].then(f):g.length>0?Promise.all(g).then(f):f()}function _resolveDependency(a,b,c,d,e,f){var g=e?f.resolveAll(a):f.resolve(a);if(void 0===g){if(b){var h=new DependencyResolutionError(a,lang.format("Dependency %1 could not be resolved.",a.formattedDependencyChain()));if($instant.test(a.getKey()))throw h;return Promise.reject(h)}return g}return d&&!e&&(g=$isPromise(g)?g.then(function(a){return _createChild(a)}):_createChild(g)),c?Promise.resolve(g):g}function _createChild(a){if(!a||!$isFunction(a.newChild))throw new Error(lang.format("Child dependency requested, but %1 is not a parent.",a));return a.newChild()}var ioc=new base2.Package(this,{name:"ioc",version:miruken.version,parent:miruken,imports:"miruken,miruken.callback,miruken.context,miruken.validate",exports:"Container,Registration,ComponentPolicy,Lifestyle,TransientLifestyle,SingletonLifestyle,ContextualLifestyle,DependencyModifiers,DependencyModel,DependencyManager,DependencyInspector,ComponentModel,ComponentBuilder,ComponentModelError,IoContainer,DependencyResolution,DependencyResolutionError,$component,$$composer,$container"});eval(this.imports);var $$composer={},$container=$createModifier(),$proxyBuilder=new ProxyBuilder,Container=Protocol.extend(Disposing,{constructor:function(a,b){this.base(a,void 0===b||b)},register:function(){},addComponent:function(a,b){},resolve:function(a){},resolveAll:function(a){}}),Registration=Protocol.extend({register:function(a,b){}}),ComponentPolicy=Protocol.extend({apply:function(a){}}),DependencyModifiers=Enum({None:0,Use:1,Lazy:2,Every:4,Dynamic:8,Optional:16,Promise:32,Invariant:64,Container:128,Child:256}),DependencyModel=Base.extend({constructor:function(a,b){b=b||DependencyModifiers.None,a instanceof Modifier&&($use.test(a)&&(b|=DependencyModifiers.Use),$lazy.test(a)&&(b|=DependencyModifiers.Lazy),$every.test(a)&&(b|=DependencyModifiers.Every),$eval.test(a)&&(b|=DependencyModifiers.Dynamic),$child.test(a)&&(b|=DependencyModifiers.Child),$optional.test(a)&&(b|=DependencyModifiers.Optional),$promise.test(a)&&(b|=DependencyModifiers.Promise),$container.test(a)&&(b|=DependencyModifiers.Container),$eq.test(a)&&(b|=DependencyModifiers.Invariant),a=Modifier.unwrap(a)),this.extend({getDependency:function(){return a},getModifiers:function(){return b},test:function(a){return(b&a)===a}})}},{coerce:function(a){return void 0===a?void 0:new DependencyModel(a)}}),DependencyManager=ArrayManager.extend({constructor:function(a){this.base(a)},mapItem:function(a){return DependencyModel(a)}}),DependencyInspector=Base.extend({inspect:function(a,b){var c=a.getDependencies();if(!c||Array2.contains(c,void 0)){var d=a.getClass();a.manageDependencies(function(a){for(;d&&d!==Base;){for(var b=[d.prototype.$inject,d.prototype.inject,d.$inject,d.inject],c=0;c<b.length;++c){var e=b[c];if(void 0!==e&&($isFunction(e)&&(e=e()),a.merge(e),!Array2.contains(e,void 0)))return}d=$ancestorOf(d)}})}}}),ComponentModel=Base.extend({constructor:function(){var a,b,c,d,e=!1,f={};this.extend({getKey:function(){return a||b},setKey:function(b){a=b},getClass:function(){var c=b;return!c&&$isClass(a)&&(c=a),c},setClass:function(a){if($isSomething(a)&&!$isClass(a))throw new TypeError(lang.format("%1 is not a class.",a));b=a},isInvariant:function(){return e},setInvariant:function(a){e=!!a},getLifestyle:function(){return c},setLifestyle:function(a){if(!($isSomething(a)||a instanceof Lifestyle))throw new TypeError(lang.format("%1 is not a Lifestyle.",a));c=a},getFactory:function(){var b=d,c=this.getClass();if(!b){var e=f[Facet.Interceptors];if(e&&e.length>0){var g=[];return c&&g.push(c),$isProtocol(a)&&g.push(a),_makeProxyFactory(g)}if(c)return _makeClassFactory(c)}return b},setFactory:function(a){if($isSomething(a)&&!$isFunction(a))throw new TypeError(lang.format("%1 is not a function.",a));d=a},getDependencies:function(a){return f[a||Facet.Parameters]},setDependencies:function(a,b){if(1===arguments.length&&(b=a,a=Facet.Parameters),$isSomething(b)&&!(b instanceof Array))throw new TypeError(lang.format("%1 is not an array.",b));f[a]=Array2.map(b,DependencyModel)},manageDependencies:function(a,b){if(1===arguments.length&&(b=a,a=Facet.Parameters),$isFunction(b)){var c=f[a],d=new DependencyManager(c);if(b(d),void 0===c){var c=d.getItems();c.length>0&&(f[a]=c)}}return c},getBurden:function(){return f}})}}),Lifestyle=Base.extend(ComponentPolicy,Disposing,DisposingMixin,{resolve:function(a){return a()},trackInstance:function(a){if(a&&$isFunction(a.dispose)){var b=this;a.extend({dispose:function(c){(c||b.disposeInstance(a,!0))&&(this.base(),this.dispose=this.base)}})}},disposeInstance:function(a,b){return!b&&a&&$isFunction(a.dispose)&&a.dispose(!0),!b},apply:function(a){a.setLifestyle(this)}}),TransientLifestyle=Lifestyle.extend(),SingletonLifestyle=Lifestyle.extend({constructor:function(a){this.extend({resolve:function(b){if(!a){var c=b();if($isPromise(c)){var d=this;return Promise.resolve(c).then(function(b){return!a&&b&&(a=b,d.trackInstance(a)),a})}c&&(a=c,this.trackInstance(a))}return a},disposeInstance:function(b,c){return!c&&b===a&&this.base(b,c)?(a=void 0,!0):!1},_dispose:function(){this.disposeInstance(a)}})}}),ContextualLifestyle=Lifestyle.extend({constructor:function(){var a={};this.extend({resolve:function(b,c){var d=c.resolve(Context);if(d){var e=assignID(d),f=a[e];if(!f){var g=b();if($isPromise(g)){var h=this;return Promise.resolve(g).then(function(b){return b&&!(f=a[e])&&(f=b,h._recordInstance(e,f,d)),f})}g&&(f=g,this._recordInstance(e,f,d))}return f}},_recordInstance:function(b,c,d){var e=this;a[b]=c,(Contextual.adoptedBy(c)||$isFunction(c.setContext))&&ContextualHelper.bindContext(c,d),this.trackInstance(c);var f=d.observe({contextEnded:function(){$isFunction(c.setContext)&&c.setContext(null),e.disposeInstance(c),delete a[b],f()}})},disposeInstance:function(b,c){if(!c)for(contextId in a)if(a[contextId]===b)return this.base(b,c),delete a[contextId],!0;return!1},_dispose:function(){for(contextId in a)this.disposeInstance(a[contextId]);a={}}})}}),ComponentBuilder=Base.extend(Registration,{constructor:function(a){var b,c,d=new ComponentModel,e=[];d.setKey(a),this.extend({invariant:function(){d.setInvariant()},boundTo:function(a){return d.setClass(a),this},dependsOn:function(){var a;return 1===arguments.length&&arguments[0]instanceof Array?a=arguments[0]:arguments.length>0&&(a=Array.prototype.slice.call(arguments)),d.setDependencies(a),this},usingFactory:function(a){return d.setFactory(a),this},instance:function(a){return d.setLifestyle(new SingletonLifestyle(a)),this},singleton:function(){return d.setLifestyle(new SingletonLifestyle),this},"transient":function(){return d.setLifestyle(new TransientLifestyle),this},contextual:function(){return d.setLifestyle(new ContextualLifestyle),this},newInContext:function(){return b=!0,this},newInChildContext:function(){return c=!0,this},interceptors:function(){var a=1===arguments.length&&arguments[0]instanceof Array?arguments[0]:Array.prototype.slice.call(arguments);return new InterceptorBuilder(this,d,a)},getPolicy:function(a){for(var b=0;b<e.length;++b){var c=e[b];if(c instanceof a)return c}},addPolicy:function(a){return this.getPolicy($classOf(a))?!1:(e.push(a),!0)},register:function(a){if(b||c){var f=d.getFactory();d.setFactory(function(a){var c=f(a),d=this.resolve(Context);return b?ContextualHelper.bindContext(c,d):ContextualHelper.bindChildContext(d,c),c})}return a.addComponent(d,e)}})}}),InterceptorBuilder=Base.extend(Registration,{constructor:function(a,b,c){this.extend({selectWith:function(a){return b.manageDependencies(Facet.InterceptorSelectors,function(b){Array2.forEach(a,function(a){a instanceof InterceptorSelector&&(selecter=$use(a)),b.append(a)})}),this},toFront:function(){return this.atIndex(0)},atIndex:function(a){return b.manageDependencies(Facet.Interceptors,function(b){Array2.forEach(c,function(c){b.insertIndex(a,c)})}),b},register:function(d,e){return b.manageDependencies(Facet.Interceptors,function(a){a.append(c)}),a.register(d,e)}})}}),DependencyResolution=Resolution.extend({constructor:function(a,b,c){var d,e;this.base(a,c),this.extend({claim:function(a,b){return this.isResolvingDependency(a)?!1:(e=a,d=b,!0)},isResolvingDependency:function(a){return a===e||b&&b.isResolvingDependency(a)},formattedDependencyChain:function(){var c=$eq.test(a),e=Modifier.unwrap(a),f=c?"`"+e+"`":e,g=d?"("+f+" <- "+d+")":f;return b?g+" <= "+b.formattedDependencyChain():g}})}});DependencyResolutionError.prototype=new Error,DependencyResolutionError.prototype.constructor=DependencyResolutionError,ComponentModelError.prototype=new Error,ComponentModelError.prototype.constructor=ComponentModelError;var IoContainer=CallbackHandler.extend(Container,{constructor:function(){var a=[new DependencyInspector];this.extend({register:function(){return Array2.flatten(arguments).map(function(a){return a.register(this,$composer)}.bind(this))},addComponent:function(b,c){c=c||[];for(var d=0;d<a.length;++d)a[d].inspect(b,c);for(var d=0;d<c.length;++d){var e=c[d];$isFunction(e.apply)&&e.apply(b)}var f=Validator($composer).validate(b);if(!f.isValid())throw new ComponentModelError(b,f);return this.registerHandler(b)},registerHandler:function(a){var b=a.getKey(),c=a.getClass(),d=a.getLifestyle()||new SingletonLifestyle,e=a.getFactory(),f=a.getBurden();return b=a.isInvariant()?$eq(b):b,_registerHandler(this,b,c,d,e,f)},addInspector:function(b){if(!$isFunction(b.inspect))throw new TypeError("Inspectors must have an inspect method.");a.push(b)},removeInspector:function(b){Array2.remove(a,b)},dispose:function(){$provide.removeAll(this)}})},$validate:[ComponentModel,function(a,b){var c=a.getObject(),d=c.getKey(),e=c.getFactory();d||a.getResults().addKey("key").addError("required",{message:"Key could not be determined for component."}),e||a.getResults().addKey("factory").addError("required",{message:"Factory could not be determined for component."})}]});"undefined"!=typeof module&&module.exports&&(module.exports=exports=ioc),eval(this.exports)},require("./base2.js"),
new function(){function _createInstanceMeta(){var a=_createInstanceMeta.spec||(_createInstanceMeta.spec={enumerable:!1,configurable:!1,writable:!1}),b=new InstanceMeta(this.constructor.$meta);return a.value=b,Object.defineProperty(this,"$meta",a),delete a.value,b}function _matchDescriptor(a,b){if("object"!==typeOf(a)||"object"!==typeOf(b))return!1;for(var c in b){var d=b[c];if(void 0===d){if(!(c in a))return!1}else{var e=a[c];if(d instanceof Array){if(!(e instanceof Array))return!1;for(var f=0;f<d.length;++f)if(e.indexOf(d[f])<0)return!1}else if(e!==d&&!_matchDescriptor(e,d))return!1}}return!0}function _cleanDescriptor(a){delete a.writable,delete a.value,delete a.get,delete a.set}function _inferProperty(a,b,c,d){for(var e=0;e<DEFAULT_GETTERS.length;++e){var f=DEFAULT_GETTERS[e];if(0==a.lastIndexOf(f,0)&&0===b.length){d.name=a.substring(f.length),d.get=b;break}}return d.get?d.set=c["set"+d.name]:0==a.lastIndexOf("set",0)&&(d.name=a.substring(3),d.set=b),!!d.name}function $using(a,b,c){if(a&&$isFunction(a.dispose)){if($isFunction(b)){var d;try{return d=b.call(c,a)}finally{$isPromise(d)?b=d:a.dispose()}}else if(!$isPromise(b))return;return b["finally"](function(){a.dispose()}),b}}function Modifier(){}function $createModifier(){function a(c){if(this===global){if(a.test(c))return c;b=!0;var d=new a(c);return b=!1,d}if(!b)throw new Error("Modifiers should not be called with the new operator.");this.getSource=function(){return c}}var b;return a.prototype=new Modifier,a.test=function(b){return b instanceof a?!0:b instanceof Modifier?a.test(b.getSource()):!1},a}function _buildProxy(a,b,c){for(var d=c.baseType||a.shift()||Base,e=d.extend(b.concat(a),{constructor:function(a){this._selectors=a[Facet.InterceptorSelectors],this._interceptors=a[Facet.Interceptors],this._delegate=a[Facet.Delegate],d!==Base&&(ctor=_proxiedMethod("constructor",this.base,d),ctor.apply(this,a[Facet.Parameters]))},extend:_proxyExtender,getDelegate:function(){return this._delegate},setDelegate:function(a){this._delegate=a},getInterceptors:function(a,b){return this._selectors&&this._selectors.length>0?Array2.reduce(this._selectors,function(c,d){return d.selectInterceptors(a,b,c)},this._interceptors):this._interceptors}},{shouldProxy:c.shouldProxy}),f=[e].concat(b),g=e.prototype,h={},i=0;i<f.length;++i){var j=f[i],k=j.prototype;for(key in k)if(!(key in h||key in _noProxyMethods||e.shouldProxy&&!e.shouldProxy(key,j))){var l=$isProtocol(j)?void 0:k[key];($isNothing(l)||$isFunction(l))&&(g[key]=_proxiedMethod(key,l,e)),h[key]=!0}}return e.extend=e.implement=_throwProxiesSealedExeception,e}function _proxyExtender(){var a=this.constructor,b=a.prototype,c=1===arguments.length?arguments[0]:{};arguments.length>=2&&(c[arguments[0]]=arguments[1]);for(methodName in c)if(!(methodName in _noProxyMethods||a.shouldProxy&&!a.shouldProxy(methodName,b))){var d=this[methodName];d&&d.baseMethod&&(this[methodName]=d.baseMethod),this.base(methodName,c[methodName]),this[methodName]=_proxiedMethod(methodName,this[methodName],b)}return this}function _proxiedMethod(a,b,c){function d(){var d=this,f=-1,g=this.getDelegate(),h=Array.prototype.slice.call(arguments);e||(e=this.getInterceptors(c,a));var i={getMethod:function(){return a},getSource:function(){return c},getArgs:function(){return h},setArgs:function(a){h=a},useDelegate:function(a){g=a},replaceDelegate:function(a){d.setDelegate(a),g=a},proceed:function(){if(++f,e&&f<e.length){var c=e[f];return c.intercept(i)}if(g){var j=g[a];if($isFunction(j))return j.apply(g,h)}else if(b)return b.apply(d,h);throw new Error(lang.format("Interceptor cannot proceed without a class or delegate method '%1'.",a))}};return i.proceed()}var e;return d.baseMethod=b,d}function _throwProxiesSealedExeception(){throw new TypeError("Proxy classes are sealed and cannot be extended from.")}function _listContents(a,b,c){if($isFunction(b))for(memberName in a){var d=a[memberName];(!c||c(d,memberName))&&b({member:d,name:memberName})}}function $isClass(a){return a&&a.prototype instanceof Base&&!$isProtocol(a)}function $classOf(a){return a&&a.constructor}function $ancestorOf(a){return a&&a.ancestor}function $isString(a){return"string"===typeOf(a)}function $isFunction(a){return a instanceof Function}function $isObject(a){return a===Object(a)}function $isPromise(a){return a&&$isFunction(a.then)}function $isSomething(a){return void 0!==a&&null!==a}function $isNothing(a){return void 0===a||null===a}function $lift(a){return function(){return a}}function checkCircularity(a,b){if(-1!==a.indexOf(b))throw new Error("Circularity detected for node "+b+".");return a.push(b),b}function _traverseSelf(a,b){a.call(b,this)}function _traverseRoot(a,b){for(var c,d=this,e=[this];$isFunction(d.getParent)&&(c=d.getParent());)checkCircularity(e,c),d=c;a.call(b,d)}function _traverseChildren(a,b,c){if(!(b&&a.call(c,this)||!$isFunction(this.getChildren)))for(var d=this.getChildren(),e=0;e<d.length;++e)if(a.call(c,d[e]))return}function _traverseAncestors(a,b,c){var d=this,e=[this];if(!b||!a.call(c,this))for(;$isFunction(d.getParent)&&(d=d.getParent())&&!a.call(c,d);)checkCircularity(e,d)}function _traverseDescendants(a,b,c){if(b)Traversal.levelOrder(this,a,c);else{var d=this;Traversal.levelOrder(this,function(b){return b!=d?a.call(c,b):void 0},c)}}function _traverseDescendantsReverse(a,b,c){if(b)Traversal.reverseLevelOrder(this,a,c);else{var d=this;Traversal.reverseLevelOrder(this,function(b){return b!=d?a.call(c,b):void 0},c)}}function _traverseParentSiblingOrSelf(a,b,c,d){if(!(b&&a.call(d,this)||!$isFunction(this.getParent))){var e=this,f=this.getParent();if(f){if($isFunction(f.getChildren))for(var g=f.getChildren(),h=0;h<g.length;++h){var i=g[h];if(i!=e&&a.call(d,i))return}c&&a.call(d,f)}}}function _preOrder(a,b,c,d){return checkCircularity(d,a),a&&$isFunction(b)&&!b.call(c,a)?($isFunction(a.traverse)&&a.traverse(function(a){return Traversal.preOrder(a,b,c)}),!1):!0}function _postOrder(a,b,c,d){return checkCircularity(d,a),a&&$isFunction(b)?($isFunction(a.traverse)&&a.traverse(function(a){return Traversal.postOrder(a,b,c)}),b.call(c,a)):!0}function _levelOrder(a,b,c,d){if(a&&$isFunction(b))for(var e=[a];e.length>0;){var f=e.shift();if(checkCircularity(d,f),b.call(c,f))return;$isFunction(f.traverse)&&f.traverse(function(a){a&&e.push(a)})}}function _reverseLevelOrder(a,b,c,d){if(a&&$isFunction(b)){for(var e=[a],f=[];e.length>0;){var g=e.shift();checkCircularity(d,g),f.push(g);var h=[];$isFunction(g.traverse)&&g.traverse(function(a){a&&h.unshift(a)}),e.push.apply(e,h)}for(;f.length>0;)if(b.call(c,f.pop()))return}}function _liftMethods(a){a=a.prototype;for(var b in a)if(!(b in this)){var c=a[b];$isFunction(c)&&(this[b]=c)}}var miruken=new base2.Package(this,{name:"miruken",version:"1.0",exports:"Enum,Protocol,Delegate,Miruken,MetaStep,MetaMacro,Disposing,DisposingMixin,Parenting,Starting,Startup,Facet,Interceptor,InterceptorSelector,ProxyBuilder,TraversingAxis,Traversing,TraversingMixin,Traversal,Variance,Modifier,ArrayManager,IndexedList,$isProtocol,$isClass,$classOf,$ancestorOf,$isString,$isFunction,$isObject,$isPromise,$isSomething,$isNothing,$using,$lift,$eq,$use,$copy,$lazy,$eval,$every,$child,$optional,$promise,$instant,$createModifier,$properties,$inferProperties,$inheritStatic"});eval(this.imports);var $eq=$createModifier(),$use=$createModifier(),$copy=$createModifier(),$lazy=$createModifier(),$eval=$createModifier(),$every=$createModifier(),$child=$createModifier(),$optional=$createModifier(),$promise=$createModifier(),$instant=$createModifier(),Enum=Base.extend({constructor:function(){throw new TypeError("Enums cannot be instantiated.")}},{coerce:function(a){return Object.freeze(this.extend(null,a))}}),Variance=Enum({Covariant:1,Contravariant:2,Invariant:3}),Delegate=Base.extend({delegate:function(a,b,c){}}),ObjectDelegate=Delegate.extend({constructor:function(a){if($isNothing(a))throw new TypeError("No object specified.");this.extend({delegate:function(b,c,d,e){var f=a[c];return!f||e&&!b.adoptedBy(a)?void 0:f.apply(a,d)}})}}),Protocol=Base.extend({constructor:function(a,b){if($isNothing(a))a=new Delegate;else if(a instanceof Delegate==!1)if($isFunction(a.toDelegate)){if(a=a.toDelegate(),a instanceof Delegate==!1)throw new TypeError(lang.format("Invalid delegate: %1 is not a Delegate nor does it have a 'toDelegate' method that returned one."))}else a=new ObjectDelegate(a);this.extend({delegate:function(c,d){return a&&a.delegate($classOf(this),c,d,b)}})}},{isProtocol:function(a){return a&&a.prototype instanceof Protocol},conformsTo:False,adoptedBy:function(a){return a&&$isFunction(a.conformsTo)?a.conformsTo(this):!1},coerce:function(a,b){return new this(a,b)}}),MetaStep=Enum({Subclass:1,Implement:2,Extend:3}),MetaMacro=Base.extend({apply:function(a,b,c,d){},shouldInherit:False,isActive:False},{coerce:function(){return this["new"].apply(this,arguments)}}),MetaBase=MetaMacro.extend({constructor:function(a){var b=[];this.extend({getParent:function(){return a},getProtocols:function(){return b.slice(0)},getAllProtocols:function(){for(var a=this.getProtocols(),b=a.slice(0),c=0;c<b.length;++c)for(var d=b[c].$meta.getAllProtocols(),e=0;e<d.length;++e){var f=d[e];a.indexOf(f)<0&&a.push(f)}return a},addProtocol:function(a){if(!$isNothing(a)){a instanceof Array||(a=Array.prototype.slice.call(arguments));for(var c=0;c<a.length;++c){var d=a[c];d.prototype instanceof Protocol&&-1===b.indexOf(d)&&(b.push(d),this.protocolAdded(d))}}},protocolAdded:function(a){},conformsTo:function(a){if(!(a&&a.prototype instanceof Protocol))return!1;for(var c=0;c<b.length;++c){var d=b[c];if(a===d||d.conformsTo(a))return!0}return!1},apply:function c(b,d,e,f){a?a.apply(b,d,e,f):$properties&&(c.p||(c.p=new $properties)).apply(b,d,e,f)},getDescriptor:function(b){return a?a.getDescriptor(b):void 0},linkBase:function(b){return this[b]||this.extend(b,function(){var c=a&&a[b];return c?c.apply(a,arguments):void 0}),this}})}}),ClassMeta=MetaBase.extend({constructor:function(a,b,c,d){var e=b===Protocol||b.prototype instanceof Protocol,f=d?d.slice(0):void 0;this.base(a.$meta,c),this.extend({getBase:function(){return a},getClass:function(){return b},isProtocol:function(){return e},getAllProtocols:function(){var b=this.base();if(!e&&a!==Base)for(var c=a.$meta.getAllProtocols(),d=0;d<c.length;++d){var f=c[d];b.indexOf(f)<0&&b.push(f)}return b},protocolAdded:function(a){e&&_liftMethods.call(b.prototype,a)},conformsTo:function(c){return c&&c.prototype instanceof Protocol?c===b||b.prototype instanceof c?!0:this.base(c)?!0:a&&a!==Base&&a!==Protocol?a.conformsTo(c):!1:!1},apply:function(a,b,c,d){if(this.base(a,b,c,d),f&&0!=f.length)for(var e=this!==b,g=a!==MetaStep.Subclass,h=0;h<f.length;++h){var i=f[h];g&&!i.isActive()||e&&!i.shouldInherit()||i.apply(a,b,c,d)}}}),this.addProtocol(c)}}),InstanceMeta=MetaBase.extend({constructor:function(a){this.base(a),this.extend({getClass:function(){return a.getClass()}})}}),extend=Base.extend;Base.extend=function(){return function(a,b){var c,d,e,f=b;for(a.prototype instanceof Protocol&&(c=[]).push(a),b.length>0&&b[0]instanceof Array&&(f=b.shift());f.length>0;){var g=f[0];if(!g)break;if(g.prototype instanceof Protocol)(c||(c=[])).push(g);else if(g instanceof MetaMacro)(e||(e=[])).push(g);else if($isFunction(g)&&g.prototype instanceof MetaMacro)(e||(e=[])).push(new g);else{if(!g.prototype)break;(d||(d=[])).push(g)}f.shift()}var h=b.shift(),i=b.shift(),j=extend.call(a,h,i),k=new ClassMeta(a,j,c,e);return Object.defineProperty(j,"$meta",{enumerable:!1,configurable:!1,writable:!1,value:k}),Object.defineProperty(j.prototype,"$meta",{enumerable:!1,configurable:!1,get:_createInstanceMeta}),j.conformsTo=k.conformsTo.bind(k),k.apply(MetaStep.Subclass,k,j.prototype,h),d&&Array2.forEach(d,j.implement,j),j}(this,Array.prototype.slice.call(arguments))},Base.prototype.conformsTo=function(a){return this.constructor.$meta.conformsTo(a)};var implement=Base.implement;Base.implement=function(a){$isFunction(a)&&(a=a.prototype);var b=this.$meta;return implement.call(this,a),b&&b.apply(MetaStep.Implement,b,this.prototype,a),this};var extendInstance=Base.prototype.extend;Base.prototype.extend=function(a,b){var c=1===arguments.length?a:{};arguments.length>=2&&(c[a]=b);var d=this.$meta;return extendInstance.call(this,c),d&&d.apply(MetaStep.Extend,d,this,c),this};var $proxyProtocol=MetaMacro.extend({apply:function(a,b,c,d){for(var e in d)if(!("delegate"===e||e in Base.prototype)){var f=c[e];$isFunction(f)&&!function(a){c[a]=function(){var b=Array.prototype.slice.call(arguments);return this.delegate(a,b)}}(e)}a===MetaStep.Subclass&&(b.getClass().adoptedBy=Protocol.adoptedBy)},shouldInherit:True,isActive:True});Protocol.extend=Base.extend,Protocol.implement=Base.implement,Protocol.$meta=new ClassMeta(Base,Protocol,null,[new $proxyProtocol]),Protocol.$meta.apply(MetaStep.Subclass,Protocol.$meta,Protocol.prototype);var $properties=MetaMacro.extend({constructor:function(a){this._tag=a||"$properties"},apply:function a(b,c,d,e){if(!$isNothing(e)&&e.hasOwnProperty(this._tag)){var f,g=e[this._tag];for(var h in g){var i=g[h],j=a.spec||(a.spec={enumerable:!0,configurable:!0}),k=!1;j.writable=!0,$isNothing(i)||$isString(i)||"number"==typeOf(i.length)||"object"!==typeOf(i)?j.value=i:(k=!0,i.get&&(j.get=i.get),i.set&&(j.set=i.set),j.get||j.set?delete j.writable:j.value=i.value),this.defineProperty(c,d,h,j),k&&(_cleanDescriptor(i),Object.freeze(i),(f||(f={}))[h]=i),_cleanDescriptor(j)}f&&c.extend({getDescriptor:function(a){if($isNothing(a))return lang.extend(lang.extend({},this.base(a)),f);if($isString(a))return f[a]||this.base(a);var b=this.base(a);for(var c in f){var d=f[c];_matchDescriptor(d,a)&&(b=b||{},lang.extend(b,c,d))}return b}}),delete e[this._tag],delete d[this._tag]}},defineProperty:function(a,b,c,d){Object.defineProperty(b,c,d)},shouldInherit:True,isActive:True}),$inferProperties=MetaMacro.extend({apply:function b(a,c,d,e){for(var f in e){var g=e[f];if($isFunction(g)){var h=b.spec||(b.spec={enumerable:!0});if(_inferProperty(f,g,e,h)){var i=h.name;i&&i.length>0&&(i=i.charAt(0).toLowerCase()+i.slice(1),i in d||this.defineProperty(c,d,i,h)),delete h.name,delete h.get,delete h.set}}}},defineProperty:function(a,b,c,d){Object.defineProperty(b,c,d)},shouldInherit:True,isActive:True}),DEFAULT_GETTERS=["get","is","can"],$inheritStatic=MetaMacro.extend({constructor:function(){var a=Array.prototype.slice.call(arguments);this.extend({apply:function(b,c,d){if(b===MetaStep.Subclass){var e=c.getClass(),f=$ancestorOf(e);if(a.length>0)for(var g=0;g<a.length;++g){var h=a[g];h in e||(e[h]=f[h])}else if(f!==Base&&f!==Object)for(var i in f)!f.hasOwnProperty(i)||i in e||(e[i]=f[i])}}})},shouldInherit:True}),Miruken=Base.extend({constructor:function(){this.base.apply(this,arguments)}},{coerce:function(){return this["new"].apply(this,arguments)}}),Disposing=Protocol.extend({dispose:function(){}}),DisposingMixin=Module.extend({dispose:function(a){$isFunction(a._dispose)&&(a._dispose(),a.dispose=Undefined)}}),Parenting=Protocol.extend({newChild:function(){}}),Starting=Protocol.extend({start:function(){}}),Startup=Base.extend(Starting,{start:function(){}});Modifier.isModified=function(a){return a instanceof Modifier},Modifier.unwrap=function(a){return a instanceof Modifier?Modifier.unwrap(a.getSource()):a};var ArrayManager=Base.extend({constructor:function(a){a=a||[],this.extend({getItems:function(){return a},getIndex:function(b){return a.length>b?a[b]:void 0},setIndex:function(b,c){return(a.length<=b||void 0===a[b])&&(a[b]=this.mapItem(c)),this},insertIndex:function(b,c){return a.splice(b,0,this.mapItem(c)),this},replaceIndex:function(b,c){return a[b]=this.mapItem(c),this},removeIndex:function(b){return a.length>b&&a.splice(b,1),this},append:function(){var b;if(1===arguments.length&&arguments[0]instanceof Array?b=arguments[0]:arguments.length>0&&(b=Array.prototype.slice.call(arguments)),b)for(var c=0;c<b.length;++c)a.push(this.mapItem(b[c]));return this},merge:function(a){for(var b=0;b<a.length;++b){var c=a[b];void 0!==c&&this.setIndex(b,c)}return this}})},mapItem:function(a){return a}}),IndexedList=Base.extend({constructor:function(a){var b={};this.extend({isEmpty:function(){return!this.head},getIndex:function(a){return a&&b[a]},insert:function(c,d){var e=this.getIndex(d),f=e;if(d)for(f=f||this.head;f&&a(c,f)>=0;)f=f.next;if(f){var g=f.prev;c.next=f,c.prev=g,f.prev=c,g&&(g.next=c),this.head===f&&(this.head=c)}else{delete c.next;var h=this.tail;h?(c.prev=h,h.next=c):(this.head=c,delete c.prev),this.tail=c}d&&(c.index=d,e||(b[d]=c))},remove:function(a){var c=a.prev,d=a.next;c?d?(c.next=d,d.prev=c):(this.tail=c,delete c.next):d?(this.head=d,delete d.prev):(delete this.head,delete this.tail);var e=a.index;this.getIndex(e)===a&&(d&&d.index===e?b[e]=d:delete b[e])}})}}),Facet=Enum({Parameters:"parameters",Interceptors:"interceptors",InterceptorSelectors:"interceptorSelectors",Delegate:"delegate"}),Interceptor=Base.extend({intercept:function(a){return a.proceed()}}),InterceptorSelector=Base.extend({selectInterceptors:function(a,b,c){return c}}),ProxyBuilder=Base.extend({buildProxy:function(a,b){if(!(a instanceof Array))throw new TypeError("ProxyBuilder requires an array of types to proxy.");var c=Array2.filter(a,$isClass),d=Array2.filter(a,$isProtocol);return _buildProxy(c,d,b||{})}}),_noProxyMethods={base:!0,extend:!0,constructor:!0,conformsTo:!0,getInterceptors:!0,getDelegate:!0,setDelegate:!0};Package.implement({"export":function(a,b){this.addName(a,b)},getProtocols:function(a){_listContents(this,a,$isProtocol)},getClasses:function(a){_listContents(this,a,function(a,b){return $isClass(a)&&"constructor"!=b})},getPackages:function(a){_listContents(this,a,function(a,b){return a instanceof Package&&"parent"!=b})}});var $isProtocol=Protocol.isProtocol,TraversingAxis=Enum({Self:1,Root:2,Child:3,Sibling:4,Ancestor:5,Descendant:6,DescendantReverse:7,ChildOrSelf:8,SiblingOrSelf:9,AncestorOrSelf:10,DescendantOrSelf:11,DescendantOrSelfReverse:12,ParentSiblingOrSelf:13}),Traversing=Protocol.extend({traverse:function(a,b,c){}}),TraversingMixin=Module.extend({traverse:function(a,b,c,d){if($isFunction(b)&&(d=c,c=b,b=TraversingAxis.Child),$isFunction(c))switch(b){case TraversingAxis.Self:_traverseSelf.call(a,c,d);break;case TraversingAxis.Root:_traverseRoot.call(a,c,d);break;case TraversingAxis.Child:_traverseChildren.call(a,c,!1,d);break;case TraversingAxis.Sibling:_traverseParentSiblingOrSelf.call(a,c,!1,!1,d);break;case TraversingAxis.ChildOrSelf:_traverseChildren.call(a,c,!0,d);break;case TraversingAxis.SiblingOrSelf:_traverseParentSiblingOrSelf.call(a,c,!0,!1,d);break;case TraversingAxis.Ancestor:_traverseAncestors.call(a,c,!1,d);break;case TraversingAxis.AncestorOrSelf:_traverseAncestors.call(a,c,!0,d);break;case TraversingAxis.Descendant:_traverseDescendants.call(a,c,!1,d);break;case TraversingAxis.DescendantReverse:_traverseDescendantsReverse.call(a,c,!1,d);break;case TraversingAxis.DescendantOrSelf:_traverseDescendants.call(a,c,!0,d);break;case TraversingAxis.DescendantOrSelfReverse:_traverseDescendantsReverse.call(a,c,!0,d);break;case TraversingAxis.ParentSiblingOrSelf:_traverseParentSiblingOrSelf.call(a,c,!0,!0,d);break;default:throw new Error("Unrecognized TraversingAxis "+b+".")}}}),Traversal=Abstract.extend({},{preOrder:function(a,b,c){return _preOrder(a,b,c,[])},postOrder:function(a,b,c){return _postOrder(a,b,c,[])},levelOrder:function(a,b,c){return _levelOrder(a,b,c,[])},reverseLevelOrder:function(a,b,c){return _reverseLevelOrder(a,b,c,[])}});void 0===Function.prototype["new"]&&(Function.prototype["new"]=function(){function a(){c.apply(this,b)}var b=arguments,c=this;return a.prototype=c.prototype,new a}),"undefined"!=typeof module&&module.exports&&(module.exports=exports=miruken),global.miruken=miruken,global.Miruken=Miruken,eval(this.exports)},module.exports=require("./mvc.js");var miruken=require("../miruken.js");require("../callback.js"),require("../context.js"),new function(){var mvc=new base2.Package(this,{name:"mvc",version:miruken.version,parent:miruken,imports:"miruken,miruken.callback,miruken.context",exports:"Model,Controller,MasterDetail,MasterDetailAware,$root"});eval(this.imports);var $root=$createModifier(),Model=Base.extend($inferProperties,{constructor:function(a){this.fromData(a)},fromData:function(a){if(!$isNothing(a)){var b=this.$meta,c=b&&b.getDescriptor();if(c)for(var d in c){var e=c[d];e&&e.root&&e.map&&(this[d]=e.map(a))}for(var d in a){var e=c&&c[d],f=e&&e.map;if(!f||!e.root){var g=a[d];if(d in this)this[d]=f?Model.map(g,f,e):g;else{var h=d.toLowerCase();for(var i in this)i.toLowerCase()===h&&(this[i]=f?Model.map(g,f,e):g)}}}}},pluck:function(){for(var a={},b=0;b<arguments.length;++b){var c=arguments[b],d=this[c];$isFunction(d)||(a[c]=d)}return a}},{map:function(a,b,c){return a?a instanceof Array?Array2.map(a,function(a){return Model.map(a,b,c)}):b(a,c):void 0},coerce:function(){return this["new"].apply(this,arguments)}}),Controller=CallbackHandler.extend($inferProperties,$contextual),MasterDetail=Protocol.extend({getSelectedDetail:function(a){},getSelectedDetails:function(a){},selectDetail:function(a){},deselectDetail:function(a){},hasPreviousDetail:function(a){},hasNextDetail:function(a){},getPreviousDetail:function(a){},getNextDetail:function(a){},addDetail:function(a){},updateDetail:function(a){},removeDetail:function(a,b){}}),MasterDetailAware=Protocol.extend({masterChanged:function(a){},didSelectDetail:function(a,b){},didDeselectDetail:function(a,b){},didRemoveDetail:function(a,b){}});eval(this.exports)},module.exports=require("./validate.js"),require("./validatejs.js");var miruken=require("../miruken.js"),Promise=require("bluebird");require("../callback.js"),new function(){function _bindValidationResults(a,b){var c=_bindValidationResults.spec||(_bindValidationResults.spec={enumerable:!1,configurable:!0,writable:!1});c.value=b,Object.defineProperty(a,"$validation",c),delete c.value}var validate=new base2.Package(this,{name:"validate",version:miruken.version,parent:miruken,imports:"miruken,miruken.callback",exports:"Validator,Validation,ValidationResult,ValidationCallbackHandler,$validate"});eval(this.imports);var $validate=$define("$validate"),Validator=Protocol.extend({validate:function(a,b,c){},validateAsync:function(a,b,c){}}),Validation=Base.extend({constructor:function(a,b,c,d){b=!!b,d=d||new ValidationResult,this.extend({isAsync:function(){return b},getObject:function(){return a},getScope:function(){return c},getResults:function(){return d}})}}),IGNORE=["isValid","valid","getErrors","errors","addKey","addError"],ValidationResult=Base.extend($inferProperties,{constructor:function(){var a,b;this.extend({isValid:function(){if(a||b)return!1;for(var c=Object.getOwnPropertyNames(this),d=0;d<c.length;++d){var e=c[d];if(!(IGNORE.indexOf(e)>=0)){var f=this[e];if(f instanceof ValidationResult&&!f.isValid())return!1}}return!0},getErrors:function(){if(b)return b;if(a){b={};for(var c in a)b[c]=a[c].slice(0)}for(var d=Object.getOwnPropertyNames(this),e=0;e<d.length;++e){var f=d[e];if(!(IGNORE.indexOf(f)>=0)){var g=this[f],h=g instanceof ValidationResult&&g.getErrors();if(h){b=b||{};for(c in h)for(var i=h[c],j=b[c],k=0;k<i.length;++k){var l=lang.pcopy(i[k]);l.key=l.key?f+"."+l.key:f,j?j.push(l):b[c]=j=[l]}}}}return b},addKey:function(a){return this[a]||(this[a]=new ValidationResult)},addError:function(c,d){var e=a||(a={}),f=e[c];return f?f.push(d):e[c]=[d],b=null,this},reset:function(){a=b=void 0;for(var c=Object.getOwnPropertyNames(this),d=0;d<c.length;++d){var e=c[d];if(!(IGNORE.indexOf(e)>=0)){var f=this[e];f instanceof ValidationResult&&delete this[e]}}return this}})}}),ValidationCallbackHandler=CallbackHandler.extend(Validator,{validate:function(a,b,c){var d=new Validation(a,!1,b,c);return $composer.handle(d,!0),c=d.getResults(),_bindValidationResults(a,c),c},validateAsync:function(a,b,c){var d=new Validation(a,!0,b,c);return $composer.deferAll(d).then(function(){return c=d.getResults(),_bindValidationResults(a,c),c})}});$handle(CallbackHandler,Validation,function(a,b){var c=a.getObject(),d=$classOf(c);return d?$validate.dispatch(this,a,d,b):void 0}),"undefined"!=typeof module&&module.exports&&(module.exports=exports=validate),eval(this.exports)};var miruken=require("../miruken.js"),validate=require("./validate.js"),validatejs=require("validate.js"),Promise=require("bluebird");require("../callback.js"),new function(){function _mapResults(a,b){b&&Array2.forEach(b,function(b){a.addKey(b.attribute).addError(b.validator,{message:b.error,value:b.value})})}function _buildConstraints(a,b){var c,d=a.$meta,e=d&&d.getDescriptor(VALIDATABLE);if(e){for(var f in e){var g=e[f],h=g.validate;(c||(c={}))[f]=h;for(name in h)if("nested"===name){var i=a[f];i&&(b[f]=i)}else name in validatejs.validators||(validatejs.validators[name]=function(){var a=$composer.resolve(name);if(!a)throw new Error("Unable to resolve validator '"+name+"'.");return a.validate.apply(a,arguments)})}return c}}var validate=new base2.Package(this,{name:"validate",version:miruken.version,parent:miruken,imports:"miruken.callback,miruken.validate",exports:"ValidateJsCallbackHandler,$required,$nested"});eval(this.imports),validatejs.Promise=Promise;var DETAILED={format:"detailed"},VALIDATABLE={validate:void 0},$required=Object.freeze({presence:!0}),$nested=Object.freeze({nested:!0});validatejs.validators.nested=Undefined;var ValidateJsCallbackHandler=CallbackHandler.extend({$validate:[null,function(a,b){var c=a.getObject(),d={},e=_buildConstraints(c,d);if(e){var f=a.getScope(),g=a.getResults(),h=Validator(b);if(a.isAsync())return validatejs.async(c,e,DETAILED).then(function(a){return!0},function(a){return a instanceof Error?Promise.reject(a):void _mapResults(g,a)})["finally"](function(){var a=[];for(var b in d){var c,e=d[b];if(e instanceof Array)for(var i=0;i<e.length;++i)c=g.addKey(b+"."+i),c=h.validateAsync(e[i],f,c);else c=g.addKey(b),c=h.validateAsync(e,f,c),a.push(c)}return Promise.all(a)});var i=validatejs(c,e,DETAILED);for(var j in d){var k=d[j];if(k instanceof Array)for(var l=0;l<k.length;++l)h.validate(k[l],f,g.addKey(j+"."+l));else h.validate(k,f,g.addKey(j))}_mapResults(g,i)}}]});eval(this.exports)};